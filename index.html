<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω Outlet - Sale Team</title>
    <script src="https://cdn.tailwindcss.com"></script>
	<!-- Supabase JS v2 CDN -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script>
		// Supabase Initialization
		const SUPABASE_URL = 'https://rvkjvnlqbzadwjgzvyfg.supabase.co';
		const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2a2p2bmxxYnphZHdqZ3p2eWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MzMyNDEsImV4cCI6MjA3NTMwOTI0MX0.Whw1wmHeK9di5ZULxa2ojOS-v5jpncQvUvhUUmqkGuk';
		const supabaseClient = window.supabase && window.supabase.createClient ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

		async function syncOutletsToSupabase() {
			try {
				if (!supabaseClient) return;
				const json = JSON.stringify(outlets || {});
				const blob = new Blob([json], { type: 'application/json' });
				const filePath = 'data/outlets.json';
				const { data: uploadResult, error } = await supabaseClient
					.storage
					.from('qcag-media')
					.upload(filePath, blob, { cacheControl: '0', upsert: true, contentType: 'application/json' });
				if (error) {
					console.error('Supabase upload error:', error);
					alert('‚ùå L·ªói l∆∞u l√™n Supabase: ' + (error.message || 'Unknown error') + '\n\nKi·ªÉm tra policies c·ªßa bucket qcag-media (INSERT).');
					throw error;
				}
				console.log('‚úÖ Supabase synced:', uploadResult);
			} catch (e) {
				console.warn('Supabase sync failed:', e.message || e);
			}
		}

		async function loadOutletsFromSupabase() {
			try {
				if (!supabaseClient) return;
				const { data } = supabaseClient.storage.from('qcag-media').getPublicUrl('data/outlets.json');
				const url = data && data.publicUrl;
				if (!url) return;
				const res = await fetch(url, { cache: 'no-store' });
				if (!res.ok) return;
				const remote = await res.json();
				if (remote && typeof remote === 'object') {
					outlets = remote;
					localStorage.setItem('outlets', JSON.stringify(outlets));
				}
			} catch (e) {
				console.warn('Supabase load failed:', e.message || e);
			}
		}

		async function uploadFileToBucket(file, pathPrefix) {
			if (!supabaseClient) throw new Error('Supabase client not initialized');
			const safeName = file.name.replace(/[^a-zA-Z0-9_.-]/g, '_');
			const filePath = `${pathPrefix}/${Date.now()}-${safeName}`;
			const { error } = await supabaseClient
				.storage
				.from('qcag-media')
				.upload(filePath, file, { cacheControl: '3600', upsert: false, contentType: file.type });
			if (error) throw error;
			const { data } = supabaseClient.storage.from('qcag-media').getPublicUrl(filePath);
			return { filePath, publicUrl: data.publicUrl };
		}
	</script>

    <style>
        body {
            box-sizing: border-box;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #fff5f0 0%, #ffe4d6 100%);
        }
        .card-shadow {
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-hover:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Modern scrollbar */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Smooth transitions for layout changes */
        #outletDetailSection, #welcomeScreen {
            transition: all 0.3s ease-in-out;
        }
        
        /* Modal styling */
        #outletDetailModal .slide-in {
            animation: slideInModal 0.3s ease-out;
        }
        
        @keyframes slideInModal {
            from { 
                opacity: 0; 
                transform: scale(0.9) translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        /* Orange theme colors */
        .bg-orange-dark { background-color: #e55a2b; }
        .bg-orange-medium { background-color: #ff6b35; }
        .bg-orange-light { background-color: #ff8c42; }
        .bg-orange-lighter { background-color: #ffad5a; }
        .text-white { color: #ffffff; }
        .text-orange-light { color: #fff5f0; }
        .text-orange-medium { color: #ffe4d6; }
        .border-orange { border-color: rgba(255, 255, 255, 0.2); }
        .border-orange-light { border-color: rgba(255, 255, 255, 0.3); }
        
        /* Keep red for warnings */
        .bg-warning { background-color: #dc3545; }
        .text-warning { color: #dc3545; }
        .border-warning { border-color: #dc3545; }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Mobile table styling */
            .mobile-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .mobile-table table {
                min-width: 800px;
            }
            
            /* Mobile modal adjustments */
            .mobile-modal {
                margin: 0.5rem;
                max-height: calc(100vh - 1rem);
            }
            
            /* Mobile form adjustments */
            .mobile-form {
                padding: 1rem;
            }
            
            /* Mobile button adjustments */
            .mobile-btn {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
            
            /* Mobile text adjustments */
            .mobile-text-sm {
                font-size: 0.75rem;
            }
            
            /* Mobile grid adjustments */
            .mobile-grid-1 {
                grid-template-columns: 1fr;
            }
            
            /* Mobile spacing adjustments */
            .mobile-px-2 {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .mobile-py-2 {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            
            /* Mobile header adjustments */
            .mobile-header {
                padding: 0.75rem 1rem;
            }
            
            /* Mobile sidebar hide */
            .mobile-hide-sidebar {
                display: none;
            }
            
            /* Mobile full width */
            .mobile-full-width {
                width: 100%;
            }
            
            /* Touch-friendly buttons */
            .touch-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Mobile dropdown adjustments */
            .mobile-dropdown {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90vw;
                max-width: 300px;
                z-index: 9999;
            }
        }

        /* Tablet adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .tablet-adjust {
                padding: 1rem;
            }
        }

        /* Desktop optimizations */
        @media (min-width: 1025px) {
            .desktop-optimize {
                max-width: 1200px;
                margin: 0 auto;
            }
        }

        /* Device detection classes */
        .is-mobile .desktop-only {
            display: none !important;
        }
        
        .is-desktop .mobile-only {
            display: none !important;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg card-shadow p-8 w-full max-w-md slide-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-orange-medium rounded-lg mx-auto mb-4 flex items-center justify-center">
                    <div class="w-8 h-8 bg-white rounded"></div>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">H·ªá Th·ªëng Qu·∫£n L√Ω Outlet</h2>
                <p class="text-gray-600">Ch·ªçn vai tr√≤ c·ªßa b·∫°n ƒë·ªÉ ti·∫øp t·ª•c</p>
            </div>
            
            <div class="space-y-4">
                <!-- User Button -->
                <button onclick="showUserForm()" class="w-full bg-orange-medium hover:bg-orange-dark text-white py-4 px-6 rounded btn-hover transition-all duration-300 font-semibold text-lg">
                    <div class="flex items-center justify-center space-x-2">
                        <span>T√¥i l√† User</span>
                    </div>
                    <div class="text-sm font-normal mt-1 opacity-90">SR/TBA ho·∫∑c SS</div>
                </button>
                
                <!-- Admin Login Section -->
                <div class="border-t border-gray-200 pt-4">
                    <p class="text-center text-sm text-gray-600 mb-3">D√†nh cho qu·∫£n tr·ªã vi√™n:</p>
                    <form id="adminLoginForm">
                        <div class="space-y-3">
                            <input type="text" id="adminName" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded text-gray-800 focus:border-orange-medium focus:outline-none transition-all duration-300" placeholder="H·ªç v√† t√™n Admin">
                            <input type="text" id="adminUsername" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded text-gray-800 focus:border-orange-medium focus:outline-none transition-all duration-300" placeholder="T√™n ƒëƒÉng nh·∫≠p Admin">
                            <input type="password" id="adminPassword" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded text-gray-800 focus:border-orange-medium focus:outline-none transition-all duration-300" placeholder="M·∫≠t kh·∫©u Admin">
                        </div>
                        
                        <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded btn-hover transition-all duration-300 mt-4 font-semibold">
                            ƒêƒÉng Nh·∫≠p Admin
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- User Login Form Modal -->
    <div id="userFormModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center" style="display: none;">
        <div class="bg-white rounded-lg card-shadow p-8 w-full max-w-md slide-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-orange-medium rounded-lg mx-auto mb-4 flex items-center justify-center">
                    <div class="w-8 h-8 bg-white rounded"></div>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Th√¥ng Tin User</h2>
                <p class="text-gray-600">Vui l√≤ng nh·∫≠p th√¥ng tin c·ªßa b·∫°n</p>
            </div>
            
            <form id="userLoginForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">H·ªç v√† T√™n *</label>
                        <input type="text" id="userFullName" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded text-gray-800 focus:border-orange-medium focus:outline-none transition-all duration-300" placeholder="Nh·∫≠p h·ªç v√† t√™n ƒë·∫ßy ƒë·ªß">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                        <input type="email" id="userEmail" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded text-gray-800 focus:border-orange-medium focus:outline-none transition-all duration-300" placeholder="example@company.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Ch·ª©c V·ª• *</label>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <button type="button" id="roleBtn1" onclick="selectRole('SR/TBA')" class="px-4 py-3 bg-gray-50 border-2 border-gray-300 rounded text-gray-800 hover:border-orange-medium hover:bg-orange-50 transition-all duration-300 text-center role-button">
                                <div class="font-semibold">SR/TBA</div>
                            </button>
                            
                            <button type="button" id="roleBtn2" onclick="selectRole('SS')" class="px-4 py-3 bg-gray-50 border-2 border-gray-300 rounded text-gray-800 hover:border-orange-medium hover:bg-orange-50 transition-all duration-300 text-center role-button">
                                <div class="font-semibold">SS</div>
                            </button>
                        </div>
                        
                        <!-- Hidden input for form validation -->
                        <input type="hidden" id="userRole" required>
                        
                        <!-- Fixed space for role description -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 h-[100px] flex items-center justify-center">
                            <div id="roleDescription" class="text-sm w-full text-center">
                                <div class="text-gray-500 italic">Ch·ªçn ch·ª©c v·ª• ƒë·ªÉ xem m√¥ t·∫£...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="hideUserForm()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 px-4 rounded transition-colors duration-300">
                        H·ªßy
                    </button>
                    <button type="submit" class="flex-1 bg-orange-medium hover:bg-orange-dark text-white py-3 px-4 rounded btn-hover transition-all duration-300 font-semibold">
                        ƒêƒÉng Nh·∫≠p
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Header -->
    <div class="bg-white shadow-lg border-b border-gray-200" id="mainHeader" style="display: none;">
        <div class="max-w-7xl mx-auto mobile-px-2 mobile-header px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2 md:space-x-3">
                    <div class="flex items-center space-x-1 md:space-x-2">
                        <div class="w-5 h-5 md:w-6 md:h-6 bg-orange-medium rounded"></div>
                        <h1 class="text-base md:text-lg font-bold text-gray-800">Qu·∫£n L√Ω Outlet</h1>
                    </div>
                    <div id="userInfo" class="flex items-center">
                        <!-- User info will be populated here -->
                    </div>
                </div>
                <div class="flex items-center space-x-1 md:space-x-3">
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1.5 md:px-3 md:py-2 rounded text-xs md:text-sm btn-hover transition-all duration-300 touch-btn">
                        <span class="hidden sm:inline">ƒêƒÉng Xu·∫•t</span>
                        <span class="sm:hidden">‚èª</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Header Section -->
    <div class="bg-orange-light shadow-sm border-b border-orange sticky top-0 z-40" id="searchFilterHeader" style="display: none;">
        <div class="max-w-7xl mx-auto mobile-px-2 px-4 mobile-py-2 py-3">
            <!-- Search Section -->
            <div class="mb-2">
                <div class="flex items-center space-x-1 md:space-x-2">
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="searchOutletCode" 
                            placeholder="Nh·∫≠p Code ho·∫∑c T√™n..."
                            class="w-full pl-3 pr-12 md:pr-16 py-2 bg-white border border-orange rounded text-gray-800 focus:border-orange-medium focus:outline-none transition-all duration-300 text-xs md:text-sm"
                            onkeyup="searchOutlet(event)"
                        >
                        <button onclick="searchOutlet()" class="absolute right-1 top-1 bottom-1 bg-orange-medium hover:bg-orange-dark text-white px-2 md:px-3 rounded text-xs btn-hover transition-all duration-300 touch-btn">
                            üîç
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="border-t border-orange pt-2">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-semibold text-white">B·ªô L·ªçc</h3>
                    <div id="filterInfo" class="text-xs text-orange-light" style="display: none;">
                        <!-- Filter info will be shown here -->
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-1 md:gap-2">
                    <div>
                        <select id="filterArea" onchange="filterOutlets()" class="w-full px-1 md:px-2 py-1.5 bg-white border border-orange rounded text-gray-800 focus:border-orange-medium focus:outline-none text-xs touch-btn">
                            <option value="">Khu v·ª±c</option>
                            <option value="S4">S4</option>
                            <option value="S5">S5</option>
                            <option value="S16">S16</option>
                            <option value="S17">S17</option>
                            <option value="S19">S19</option>
                            <option value="S24">S24</option>
                        </select>
                    </div>
                    
                    <div>
                        <select id="filterStatus" onchange="filterOutlets()" class="w-full px-1 md:px-2 py-1.5 bg-white border border-orange rounded text-gray-800 focus:border-orange-medium focus:outline-none text-xs touch-btn">
                            <option value="">Tr·∫°ng th√°i</option>
                            <option value="completed">Ho√†n th√†nh</option>
                            <option value="pending">Ch∆∞a xong</option>
                            <option value="no-requests">Ch∆∞a c√≥ YC</option>
                        </select>
                    </div>
                    
                    <div>
                        <select id="sortBy" onchange="filterOutlets()" class="w-full px-1 md:px-2 py-1.5 bg-white border border-orange rounded text-gray-800 focus:border-orange-medium focus:outline-none text-xs touch-btn">
                            <option value="code-asc">Code A-Z</option>
                            <option value="code-desc">Code Z-A</option>
                            <option value="name-asc">T√™n A-Z</option>
                            <option value="name-desc">T√™n Z-A</option>
                            <option value="area-asc">Khu v·ª±c</option>
                            <option value="pending-desc">Nhi·ªÅu YC</option>
                        </select>
                    </div>
                    
                    <div>
                        <button onclick="clearFilters()" class="w-full bg-white hover:bg-gray-100 text-gray-800 px-1 md:px-2 py-1.5 rounded text-xs btn-hover transition-all duration-300 touch-btn">
                            X√≥a L·ªçc
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content - 2 Column Layout -->
    <div class="max-w-7xl mx-auto mobile-px-2 px-4 mobile-py-2 py-6" id="mainContent" style="display: none;">
        <!-- Mobile: Single column with hamburger menu -->
        <div class="block md:hidden">
            <!-- Mobile Header with Hamburger Menu -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center space-x-2">
                    <span>üè™</span>
                    <span>Danh S√°ch Outlet</span>
                    <span id="outletCount" class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-sm">0</span>
                </h3>
                
                <!-- Hamburger Menu Button -->
                <button 
                    id="mobileMenuToggle" 
                    onclick="toggleMobileMenu()" 
                    class="bg-orange-medium hover:bg-orange-dark text-white p-2 rounded-lg transition-all duration-300 touch-btn flex flex-col items-center justify-center space-y-1"
                    title="Xem outlet ch∆∞a ho√†n th√†nh"
                >
                    <div class="w-5 h-0.5 bg-white transition-all duration-300" id="hamburger-line-1"></div>
                    <div class="w-5 h-0.5 bg-white transition-all duration-300" id="hamburger-line-2"></div>
                    <div class="w-5 h-0.5 bg-white transition-all duration-300" id="hamburger-line-3"></div>
                </button>
            </div>
            
            <!-- Mobile Create Outlet Button -->
            <div class="mb-3">
                <button id="createOutletBtnMobile" onclick="showCreateOutlet()" class="w-full bg-orange-medium hover:bg-orange-dark text-white px-3 py-2 rounded text-xs btn-hover transition-all duration-300 touch-btn font-medium">
                    + T·∫°o Outlet M·ªõi
                </button>
            </div>

            <!-- Mobile: Danh s√°ch Outlet (Always visible) -->
            <div class="bg-white rounded-lg card-shadow p-4 mb-4">
                <div id="outletGridContainer" class="grid grid-cols-1 gap-4 max-h-96 overflow-y-auto">
                    <!-- Outlet cards will be populated here -->
                </div>
            </div>

            <!-- Mobile: Pending Outlets Overlay Tab -->
            <div id="mobilePendingOverlay" class="fixed inset-4 bg-white z-40 transform translate-x-full transition-transform duration-300 ease-in-out rounded-lg shadow-2xl" style="display: none;">
                <!-- Overlay Header -->
                <div class="bg-red-500 px-4 py-3 shadow-lg rounded-t-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <h3 class="text-base font-bold text-white">Outlet Ch∆∞a Ho√†n Th√†nh</h3>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="pendingOutletCountOverlay" class="bg-white text-red-500 px-2 py-1 rounded-full text-xs font-bold">0</span>
                            <button onclick="closeMobilePendingOverlay()" class="text-white hover:bg-red-600 p-2 rounded-lg transition-colors touch-btn">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Overlay Content -->
                <div class="flex-1 overflow-y-auto p-3 bg-gray-50">
                    <div id="pendingOutletsListOverlay" class="space-y-2">
                        <!-- Pending outlets will be populated here -->
                    </div>
                    <div id="noPendingOutletsOverlay" class="text-center py-8 text-gray-600" style="display: none;">
                        <div class="w-12 h-12 bg-green-100 rounded-full mx-auto mb-3 flex items-center justify-center">
                            <div class="w-6 h-6 bg-green-500 rounded-full"></div>
                        </div>
                        <h4 class="text-base font-semibold text-gray-800 mb-1">Tuy·ªát v·ªùi! üéâ</h4>
                        <p class="text-xs">T·∫•t c·∫£ outlet ƒë√£ ho√†n th√†nh!</p>
                    </div>
                </div>
                
                <!-- Quick Stats Footer -->
                <div class="bg-white border-t border-gray-200 px-3 py-2 rounded-b-lg">
                    <div class="flex items-center justify-between text-xs text-gray-600">
                        <span>üìä Th·ªëng k√™</span>
                        <span id="pendingStatsOverlay">0 outlet c·∫ßn x·ª≠ l√Ω</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop: 2 Column Layout -->
        <div class="hidden md:flex md:space-x-6">
            <!-- C·ªôt 1: Danh S√°ch Outlet (L·ªõn h∆°n) -->
            <div class="flex-1">
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="mb-6">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center space-x-3">
                                <span>üè™</span>
                                <span>Danh S√°ch Outlet</span>
                                <span id="outletCountDesktop" class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-semibold">0</span>
                            </h3>
                            <button id="createOutletBtnDesktop" onclick="showCreateOutlet()" class="bg-orange-medium hover:bg-orange-dark text-white px-4 py-2 rounded text-sm btn-hover transition-all duration-300 font-semibold">
                                + T·∫°o Outlet M·ªõi
                            </button>
                        </div>
                    </div>
                    
                    <!-- Desktop Table View -->
                    <div class="overflow-x-auto max-h-[600px]">
                        <table class="w-full text-sm">
                            <thead class="bg-orange-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Code</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">T√™n Outlet</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Khu V·ª±c</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Y√™u C·∫ßu</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Ch∆∞a Xong</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Thao T√°c</th>
                                </tr>
                            </thead>
                            <tbody id="outletTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Outlet rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- C·ªôt 2: Outlet Ch∆∞a Ho√†n Th√†nh (Nh·ªè h∆°n) -->
            <div class="w-80">
                <div class="bg-white rounded-lg card-shadow p-6 sticky top-4">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Outlet Ch∆∞a Ho√†n Th√†nh</h3>
                        <span id="pendingOutletCountDesktop" class="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-semibold">0</span>
                    </div>
                    <div id="pendingOutletsListDesktop" class="space-y-4 max-h-[500px] overflow-y-auto">
                        <!-- Pending outlets will be populated here -->
                    </div>
                    <div id="noPendingOutletsDesktop" class="text-center py-8 text-gray-600" style="display: none;">
                        <div class="w-12 h-12 bg-green-100 rounded-full mx-auto mb-3 flex items-center justify-center">
                            <div class="w-6 h-6 bg-green-500 rounded-full"></div>
                        </div>
                        <p class="text-sm">T·∫•t c·∫£ outlet ƒë√£ ho√†n th√†nh!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Outlet Detail Modal -->
    <div id="outletDetailModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-lg card-shadow w-full max-w-6xl max-h-[90vh] overflow-hidden slide-in">
                <!-- Modal Header -->
                <div class="bg-orange-medium px-6 py-4 border-b border-orange">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h2 class="text-lg md:text-xl font-bold text-white" id="outletDetailTitle">Chi Ti·∫øt Outlet</h2>
                            <p class="text-orange-light text-sm" id="outletDetailInfo"></p>
                        </div>
                        <div class="flex items-center space-x-2 md:space-x-3">
                            <button onclick="showNewRequestForm()" class="bg-white hover:bg-orange-50 text-orange-600 border-2 border-orange-500 px-2 py-1.5 md:px-4 md:py-2 rounded btn-hover transition-all duration-300 font-semibold shadow-lg text-xs md:text-sm">
                                <span class="hidden sm:inline">Th√™m Y√™u C·∫ßu M·ªõi</span>
                                <span class="sm:hidden">+ YC</span>
                            </button>
                            <button onclick="closeOutletDetail()" class="bg-orange-dark hover:bg-red-600 text-white px-2 py-1.5 md:px-3 md:py-2 rounded btn-hover transition-all duration-300 text-xs md:text-sm">
                                <span class="hidden sm:inline">ƒê√≥ng</span>
                                <span class="sm:hidden">‚úï</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Content - Scrollable Request Table/Grid -->
                <div class="overflow-y-auto" style="max-height: calc(100vh - 200px);">
                    <div class="p-6">
                        <div class="mb-4 flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="bg-white border-orange">
                                <label for="selectAll" class="text-sm text-gray-700">Ch·ªçn t·∫•t c·∫£</label>
                            </div>
                            <div class="text-sm text-gray-600">
                                <span id="requestCount">0</span> y√™u c·∫ßu
                            </div>
                        </div>
                        
                        <!-- Desktop Table View -->
                        <div class="hidden md:block overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-orange-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">STT</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Ng∆∞·ªùi YC</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">H·∫°ng M·ª•c</th>
                                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Ng√†y T·∫°o</th>
                                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Tr·∫°ng Th√°i</th>
                                        <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Thao T√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="requestTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Request rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Mobile Grid View -->
                        <div id="requestGridContainer" class="md:hidden grid grid-cols-1 gap-4">
                            <!-- Request cards will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



        <!-- Edit Outlet Form -->
        <div id="editOutletModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4" style="display: none;">
            <div class="bg-white rounded-lg card-shadow p-6 w-full max-w-md slide-in">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Ch·ªânh S·ª≠a Outlet</h3>
                    <form id="editOutletForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Outlet Code *</label>
                                <input type="text" id="editOutletCode" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded text-gray-600 cursor-not-allowed">
                                <p class="text-xs text-gray-500 mt-1">Outlet Code kh√¥ng th·ªÉ thay ƒë·ªïi</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n Outlet *</label>
                                <input type="text" id="editOutletName" required class="w-full px-3 py-2 bg-white border border-gray-300 rounded text-gray-800 focus:border-orange-medium focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ƒê·ªãa Ch·ªâ *</label>
                                <textarea id="editOutletAddress" required rows="2" class="w-full px-3 py-2 bg-white border border-gray-300 rounded text-gray-800 focus:border-orange-medium focus:outline-none resize-none"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Khu V·ª±c *</label>
                                <select id="editOutletArea" required class="w-full px-3 py-2 bg-white border border-gray-300 rounded text-gray-800 focus:border-orange-medium focus:outline-none">
                                    <option value="">Ch·ªçn khu v·ª±c</option>
                                    <option value="S4">S4</option>
                                    <option value="S5">S5</option>
                                    <option value="S16">S16</option>
                                    <option value="S17">S17</option>
                                    <option value="S19">S19</option>
                                    <option value="S24">S24</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button type="button" onclick="hideEditOutlet()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded transition-colors duration-300">
                                H·ªßy
                            </button>
                            <button type="submit" class="flex-1 bg-orange-medium hover:bg-orange-dark text-white py-2 px-4 rounded btn-hover transition-all duration-300">
                                C·∫≠p Nh·∫≠t
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Create Outlet Form -->
        <div id="createOutletModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display: none;">
            <div class="bg-white rounded-xl card-shadow p-6 w-full max-w-md slide-in">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üè™ T·∫°o Outlet M·ªõi</h3>
                    <form id="createOutletForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Outlet Code *</label>
                                <input 
                                    type="text" 
                                    id="newOutletCode" 
                                    required 
                                    class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" 
                                    placeholder="Nh·∫≠p ƒë√∫ng 8 ch·ªØ s·ªë (VD: 10000001, 20000001)"
                                    onblur="checkOutletCodeExists(this.value)"
                                    oninput="validateOutletCodeInput(this)"
                                    pattern="[0-9]{8}"
                                    inputmode="numeric"
                                    maxlength="8"
                                >
                                <p class="text-xs text-gray-500 mt-1">‚ö†Ô∏è Ph·∫£i nh·∫≠p ƒë√∫ng 8 ch·ªØ s·ªë (0-9), kh√¥ng ƒë∆∞·ª£c nh·∫≠p ch·ªØ</p>
                                <div id="codeCheckResult" class="mt-2 text-sm" style="display: none;"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n Outlet *</label>
                                <input type="text" id="newOutletName" required class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ƒê·ªãa Ch·ªâ *</label>
                                <textarea id="newOutletAddress" required rows="2" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none resize-none" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt c·ªßa outlet"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Khu V·ª±c *</label>
                                <select id="newOutletArea" required class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                    <option value="">Ch·ªçn khu v·ª±c</option>
                                    <option value="S4">S4</option>
                                    <option value="S5">S5</option>
                                    <option value="S16">S16</option>
                                    <option value="S17">S17</option>
                                    <option value="S19">S19</option>
                                    <option value="S24">S24</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button type="button" onclick="hideCreateOutlet()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg transition-colors duration-300">
                                H·ªßy
                            </button>
                            <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg btn-hover transition-all duration-300">
                                T·∫°o Outlet
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Upload Maquette Modal -->
        <div id="uploadMaquetteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display: none;">
            <div class="bg-white rounded-lg p-6 w-full max-w-md slide-in">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Upload Maquette</h3>
                    <form id="uploadMaquetteForm">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Th√¥ng Tin</label>
                                <div id="requestInfo" class="bg-gray-50 p-3 rounded text-sm text-gray-700">
                                    <!-- Request info will be populated here -->
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Files *</label>
                                <input 
                                    type="file" 
                                    id="maquetteFiles" 
                                    accept="image/*,.pdf" 
                                    multiple 
                                    required
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:border-orange-medium focus:outline-none file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-gray-100"
                                >
                                <div id="maquettePreview" class="mt-2 grid grid-cols-2 gap-2" style="display: none;">
                                    <!-- Maquette previews will appear here -->
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Ghi Ch√∫</label>
                                <textarea 
                                    id="completionNotes" 
                                    rows="2" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:border-orange-medium focus:outline-none resize-none" 
                                    placeholder="Ghi ch√∫ ho√†n th√†nh..."
                                ></textarea>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2 mt-4">
                            <button type="button" onclick="hideUploadMaquette()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-3 rounded text-sm">
                                H·ªßy
                            </button>
                            <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded text-sm">
                                Ho√†n Th√†nh
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- View Maquette Modal -->
        <div id="viewMaquetteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display: none;">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto slide-in">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Xem Chi Ti·∫øt</h3>
                    <div id="maquetteContent">
                        <!-- Maquette content will be populated here -->
                    </div>
                    <div class="flex justify-end mt-4">
                        <button onclick="hideViewMaquette()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 rounded text-sm">
                            ƒê√≥ng
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Maquette Modal -->
        <div id="editMaquetteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display: none;">
            <div class="bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto slide-in">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">S·ª≠a Maquette</h3>
                    <form id="editMaquetteForm">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Th√¥ng Tin</label>
                                <div id="editRequestInfo" class="bg-gray-50 p-3 rounded text-sm text-gray-700">
                                    <!-- Request info will be populated here -->
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Files Hi·ªán T·∫°i</label>
                                <div id="currentMaquetteFiles" class="bg-blue-50 p-3 rounded mb-2 text-sm">
                                    <!-- Current files will be shown here -->
                                </div>
                                
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Thay ƒê·ªïi Files</label>
                                <input 
                                    type="file" 
                                    id="editMaquetteFiles" 
                                    accept="image/*,.pdf" 
                                    multiple 
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:border-orange-medium focus:outline-none file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-gray-100"
                                >
                                <div id="editMaquettePreview" class="mt-2 grid grid-cols-2 gap-2" style="display: none;">
                                    <!-- New maquette previews will appear here -->
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Ghi Ch√∫</label>
                                <textarea 
                                    id="editCompletionNotes" 
                                    rows="2" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:border-orange-medium focus:outline-none resize-none" 
                                    placeholder="C·∫≠p nh·∫≠t ghi ch√∫..."
                                ></textarea>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2 mt-4">
                            <button type="button" onclick="hideEditMaquette()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-3 rounded text-sm">
                                H·ªßy
                            </button>
                            <button type="submit" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-2 px-3 rounded text-sm">
                                C·∫≠p Nh·∫≠t
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Request Modal -->
        <div id="editRequestModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display: none;">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto slide-in">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800" id="commentRoleTitle">Y√™u C·∫ßu Ch·ªânh S·ª≠a</h3>
                        <button onclick="hideEditRequest()" class="text-gray-400 hover:text-gray-600 text-xl">√ó</button>
                    </div>
                    
                    <!-- Request Info -->
                    <div class="bg-gray-50 p-3 rounded mb-4">
                        <div id="editRequestBasicInfo" class="text-sm text-gray-700">
                            <!-- Request basic info will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Edit History -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-gray-800 text-sm">L·ªãch S·ª≠</h4>
                            <span id="editHistoryCount" class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs">0</span>
                        </div>
                        <div id="editHistoryList" class="space-y-2 max-h-48 overflow-y-auto">
                            <!-- Edit history will be populated here -->
                        </div>
                    </div>
                    
                    <!-- New Edit Form -->
                    <div class="border-t pt-4">
                        <form id="editRequestForm">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2" id="commentLabel">N·ªôi Dung *</label>
                                <textarea 
                                    id="editRequestContent" 
                                    required
                                    rows="3" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:border-orange-medium focus:outline-none resize-none" 
                                    placeholder=""
                                ></textarea>
                                <p class="text-xs text-gray-500 mt-1" id="commentHint">M√¥ t·∫£ chi ti·∫øt</p>
                            </div>
                            
                            <div class="flex space-x-2 mt-4">
                                <button type="button" onclick="hideEditRequest()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-3 rounded text-sm">
                                    H·ªßy
                                </button>
                                <button type="button" onclick="submitComment(false)" class="flex-1 bg-orange-medium hover:bg-orange-dark text-white py-2 px-3 rounded text-sm">
                                    G·ª≠i
                                </button>
                                <button type="button" onclick="submitComment(true)" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded text-sm" id="markDoneBtn">
                                    Xong
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Request Form -->
        <div id="newRequestModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display: none;">
            <div class="bg-white rounded-lg p-6 w-full max-w-xl max-h-[90vh] overflow-y-auto slide-in">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">T·∫°o Y√™u C·∫ßu M·ªõi</h3>
                    <form id="newRequestForm">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">T√™n Ng∆∞·ªùi Y√™u C·∫ßu *</label>
                                <input type="text" id="requesterName" required readonly class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100 text-gray-600 cursor-not-allowed">
                                <p class="text-xs text-gray-500 mt-1">T·ª± ƒë·ªông ƒëi·ªÅn t·ª´ th√¥ng tin ƒëƒÉng nh·∫≠p</p>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">ƒê·ªãa Ch·ªâ *</label>
                                <textarea id="requestAddress" required rows="2" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-orange-medium focus:outline-none resize-none" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt"></textarea>
                            </div>

                            <!-- Request Items -->
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <label class="block text-sm font-semibold text-gray-700">H·∫°ng M·ª•c *</label>
                                    <button type="button" onclick="addRequestItem()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold">
                                        + Th√™m H·∫°ng M·ª•c
                                    </button>
                                </div>
                                <div id="requestItemsContainer">
                                    <!-- Request items will be added here -->
                                </div>
                            </div>

                            <!-- Content Section -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">N·ªôi Dung B·∫£ng Hi·ªáu</label>
                                <textarea id="requestContent" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-orange-medium focus:outline-none resize-none" placeholder="N·ªôi dung hi·ªÉn th·ªã"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">H√¨nh ·∫¢nh *</label>
                                <input type="file" id="requestImage" accept="image/*" multiple required class="w-full px-3 py-2 border border-gray-300 rounded focus:border-orange-medium focus:outline-none file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-gray-100">
                                <div class="text-xs text-gray-600 mt-1 bg-blue-50 p-2 rounded border border-blue-200">
                                    <div class="font-semibold text-blue-700 mb-1">üì∑ H∆∞·ªõng d·∫´n ch·ª•p ·∫£nh:</div>
                                    <div class="space-y-1">
                                        <div>‚Ä¢ <strong>C√≥ th·ªÉ up nhi·ªÅu h√¨nh</strong> - ch·ªçn t·∫•t c·∫£ ·∫£nh c·∫ßn thi·∫øt</div>
                                        <div>‚Ä¢ <strong>N·ªôi dung c≈©:</strong> Ch·ª•p c·∫≠n c·∫£nh n·ªôi dung hi·ªán t·∫°i</div>
                                        <div>‚Ä¢ <strong>V·ªã tr√≠:</strong> Ch·ª•p to√†n c·∫£nh v·ªã tr√≠ l·∫Øp ƒë·∫∑t</div>
                                        <div>‚Ä¢ <strong>G√≥c ƒë·ªô:</strong> Ch·ª•p t·ª´ nhi·ªÅu g√≥c kh√°c nhau</div>
                                    </div>
                                </div>
                                <div id="imagePreview" class="mt-2 grid grid-cols-3 gap-2" style="display: none;">
                                    <!-- Image previews will appear here -->
                                </div>
                            </div>
                        </div>

                        <div class="flex space-x-2 mt-4">
                            <button type="button" onclick="hideNewRequestForm()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-3 rounded text-sm">
                                H·ªßy
                            </button>
                            <button type="submit" class="flex-1 bg-orange-medium hover:bg-orange-dark text-white py-2 px-3 rounded text-sm btn-hover transition-all duration-300">
                                T·∫°o Y√™u C·∫ßu
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let outlets = JSON.parse(localStorage.getItem('outlets')) || {};
        let currentOutletCode = null;
        let currentRequestId = null;
        let currentUser = null;

        // User accounts
        const users = {
            'admin': {
                password: 'admin123',
                role: 'admin',
                name: 'Qu·∫£n Tr·ªã Vi√™n',
                permissions: ['view', 'create', 'edit', 'delete', 'upload', 'manage']
            }
        };


        // Authentication functions
        function login(username, password) {
            const user = users[username];
            if (user && user.password === password) {
                currentUser = {
                    username: username,
                    ...user
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                return true;
            }
            return false;
        }

        function logout() {
            if (confirm('üö™ B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('mainHeader').style.display = 'none';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('loginForm').reset();
            }
        }

        function checkPermission(permission) {
            return currentUser && currentUser.permissions.includes(permission);
        }

        function initializeUI() {
            if (!currentUser) return;
            
            // Show main interface
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('mainHeader').style.display = 'block';
            document.getElementById('searchFilterHeader').style.display = 'block';
            document.getElementById('mainContent').style.display = 'block';
            
            // Update user info
            const userInfo = document.getElementById('userInfo');
            let roleColor, roleIcon, displayText;
            
            if (currentUser.role === 'admin') {
                roleColor = 'bg-red-600 text-white';
                roleIcon = 'üîß';
                displayText = `${currentUser.name} (Admin)`;
            } else if (currentUser.position === 'SR/TBA') {
                roleColor = 'bg-blue-600 text-white';
                roleIcon = 'üë§';
                displayText = `${currentUser.name} (SR/TBA)`;
            } else if (currentUser.position === 'SS') {
                roleColor = 'bg-green-600 text-white';
                roleIcon = 'üë•';
                displayText = `${currentUser.name} (SS)`;
            } else {
                roleColor = 'bg-gray-600 text-white';
                roleIcon = '‚óè';
                displayText = currentUser.name;
            }
            
            userInfo.innerHTML = `
                <span class="${roleColor} px-2 py-1 rounded-full text-xs font-medium">
                    ${roleIcon} ${displayText}
                </span>
            `;
            
            // Update dashboard title
            const dashboardTitle = document.getElementById('dashboardTitle');
            dashboardTitle.textContent = currentUser.role === 'admin' ? 'Admin Dashboard' : 'User Dashboard';
            
            // Show/hide create outlet button (only in main content area)
            const createOutletBtnDesktop = document.getElementById('createOutletBtnDesktop');
            const createOutletBtnMobile = document.getElementById('createOutletBtnMobile');
            if (checkPermission('create') || checkPermission('manage')) {
                if (createOutletBtnDesktop) createOutletBtnDesktop.style.display = 'block';
                if (createOutletBtnMobile) createOutletBtnMobile.style.display = 'block';
            } else {
                if (createOutletBtnDesktop) createOutletBtnDesktop.style.display = 'none';
                if (createOutletBtnMobile) createOutletBtnMobile.style.display = 'none';
            }
            
            // Load data
            loadOutletList();
        }

        // Check for existing session
        function checkSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                initializeUI();
            } else {
                document.getElementById('loginModal').style.display = 'flex';
            }
        }

        // User form functions
        function showUserForm() {
            document.getElementById('userFormModal').style.display = 'flex';
        }

        function hideUserForm() {
            document.getElementById('userFormModal').style.display = 'none';
            document.getElementById('userLoginForm').reset();
            
            // Reset role selection
            document.querySelectorAll('.role-button').forEach(btn => {
                btn.classList.remove('border-orange-500', 'bg-orange-100');
                btn.classList.add('border-gray-300', 'bg-gray-50');
            });
            
            // Reset role description to default
            document.getElementById('roleDescription').innerHTML = '<div class="text-gray-500 italic">Ch·ªçn ch·ª©c v·ª• ƒë·ªÉ xem m√¥ t·∫£...</div>';
        }

        function loginAsUser(fullName, email, role) {
            const permissions = role === 'SR/TBA' ? ['view', 'create', 'edit'] : ['view', 'edit']; // SS kh√¥ng ƒë∆∞·ª£c t·∫°o y√™u c·∫ßu m·ªõi
            
            currentUser = {
                username: email,
                role: role,
                name: fullName,
                email: email,
                position: role,
                permissions: permissions
            };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            initializeUI();
            
            const roleDescription = role === 'SR/TBA' ? 'B·∫°n c√≥ th·ªÉ xem, t·∫°o y√™u c·∫ßu v√† comment ch·ªânh s·ª≠a.' : 'B·∫°n c√≥ th·ªÉ xem v√† comment ch·ªânh s·ª≠a (kh√¥ng th·ªÉ t·∫°o y√™u c·∫ßu m·ªõi).';
            alert(`‚úÖ Ch√†o m·ª´ng ${fullName}!\n\nCh·ª©c v·ª•: ${role}\n${roleDescription}`);
        }

        // Role selection function
        function selectRole(role) {
            // Reset all buttons
            document.querySelectorAll('.role-button').forEach(btn => {
                btn.classList.remove('border-orange-500', 'bg-orange-100');
                btn.classList.add('border-gray-300', 'bg-gray-50');
            });
            
            // Activate selected button
            const selectedBtn = role === 'SR/TBA' ? document.getElementById('roleBtn1') : document.getElementById('roleBtn2');
            selectedBtn.classList.remove('border-gray-300', 'bg-gray-50');
            selectedBtn.classList.add('border-orange-500', 'bg-orange-100');
            
            // Set hidden input value
            document.getElementById('userRole').value = role;
            
            // Update role description in fixed space
            const roleDescription = document.getElementById('roleDescription');
            
            if (role === 'SR/TBA') {
                roleDescription.innerHTML = `
                    <div class="text-blue-600 font-semibold text-sm">üë§ Sale Representative / Territory Business Advisor</div>
                    <div class="text-gray-600 mt-2 text-xs leading-relaxed">C√≥ th·ªÉ xem outlet, t·∫°o y√™u c·∫ßu m·ªõi v√† g·ª≠i comment ch·ªânh s·ª≠a</div>
                `;
            } else if (role === 'SS') {
                roleDescription.innerHTML = `
                    <div class="text-green-600 font-semibold text-sm">üë• Sale Supervisor</div>
                    <div class="text-gray-600 mt-2 text-xs leading-relaxed">C√≥ th·ªÉ xem outlet v√† g·ª≠i comment ch·ªânh s·ª≠a (kh√¥ng t·∫°o y√™u c·∫ßu m·ªõi)</div>
                `;
            }
        }

        // User login form handler
        document.getElementById('userLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('userFullName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;
            
            if (!fullName || !email || !role) {
                alert('‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }
            
            hideUserForm();
            loginAsUser(fullName, email, role);
        });

        // Admin login form handler
        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const adminName = document.getElementById('adminName').value.trim();
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (!adminName) {
                alert('‚ùå Vui l√≤ng nh·∫≠p h·ªç v√† t√™n Admin!');
                return;
            }
            
            if (login(username, password)) {
                // C·∫≠p nh·∫≠t t√™n admin
                currentUser.name = adminName;
                currentUser.displayName = adminName;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                initializeUI();
                alert(`‚úÖ ƒêƒÉng nh·∫≠p Admin th√†nh c√¥ng!\n\nCh√†o m·ª´ng ${adminName}! B·∫°n c√≥ to√†n quy·ªÅn qu·∫£n l√Ω h·ªá th·ªëng.`);
            } else {
                alert('‚ùå Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u Admin!\n\nVui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.');
                document.getElementById('adminPassword').value = '';
            }
        });

        // Initialize with sample data
        if (Object.keys(outlets).length === 0) {
            outlets = {
                '12345678': {
                    name: 'Qu√°n Bia ABC',
                    address: '123 Ph·ªë Hu·∫ø, Hai B√† Tr∆∞ng, H√† N·ªôi',
                    area: 'S4',
                    requests: [
                        {
                            id: 1,
                            requesterName: 'Nguy·ªÖn VƒÉn A',
                            area: 'S4',
                            brand: 'Tiger',
                            address: '123 Ph·ªë Hu·∫ø, Hai B√† Tr∆∞ng, H√† N·ªôi',
                            type: 'B·∫£ng Hi·ªáu',
                            width: 200,
                            height: 80,
                            content: 'QU√ÅN BIA ABC - TIGER BEER',
                            createdAt: '2024-01-15 14:30:00'
                        },
                        {
                            id: 2,
                            requesterName: 'Tr·∫ßn Th·ªã B',
                            area: 'S5',
                            brand: 'Heineken',
                            address: '456 Nguy·ªÖn Tr√£i, Thanh Xu√¢n, H√† N·ªôi',
                            type: 'H·ªôp ƒê√®n',
                            width: 150,
                            height: 60,
                            content: 'HEINEKEN - FRESH BEER',
                            createdAt: '2024-01-20 09:15:00'
                        }
                    ]
                }
            };
            saveData();
        }

        async function saveData() {
            localStorage.setItem('outlets', JSON.stringify(outlets));
            await syncOutletsToSupabase();
        }

        let filteredOutlets = {};

        function filterOutlets() {
            const searchValue = document.getElementById('searchOutletCode').value.trim().toLowerCase();
            const filterArea = document.getElementById('filterArea').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const sortBy = document.getElementById('sortBy').value;
            
            // Start with all outlets
            let filtered = Object.entries(outlets);
            
            // Apply search filter
            if (searchValue) {
                filtered = filtered.filter(([code, outlet]) => {
                    return code.toLowerCase().includes(searchValue) || 
                           outlet.name.toLowerCase().includes(searchValue);
                });
            }
            
            // Apply area filter
            if (filterArea) {
                filtered = filtered.filter(([code, outlet]) => outlet.area === filterArea);
            }
            
            // Apply status filter
            if (filterStatus) {
                filtered = filtered.filter(([code, outlet]) => {
                    const requests = outlet.requests || [];
                    const pendingCount = requests.filter(r => !r.completed).length;
                    
                    switch (filterStatus) {
                        case 'completed':
                            return requests.length > 0 && pendingCount === 0;
                        case 'pending':
                            return pendingCount > 0;
                        case 'no-requests':
                            return requests.length === 0;
                        default:
                            return true;
                    }
                });
            }
            
            // Apply sorting
            filtered.sort(([codeA, outletA], [codeB, outletB]) => {
                switch (sortBy) {
                    case 'code-desc':
                        return codeB.localeCompare(codeA);
                    case 'name-asc':
                        return outletA.name.localeCompare(outletB.name);
                    case 'name-desc':
                        return outletB.name.localeCompare(outletA.name);
                    case 'area-asc':
                        return outletA.area.localeCompare(outletB.area);
                    case 'pending-desc':
                        const pendingA = (outletA.requests || []).filter(r => !r.completed).length;
                        const pendingB = (outletB.requests || []).filter(r => !r.completed).length;
                        return pendingB - pendingA;
                    case 'code-asc':
                    default:
                        return codeA.localeCompare(codeB);
                }
            });
            
            // Convert back to object for display
            filteredOutlets = Object.fromEntries(filtered);
            
            // Update display
            displayFilteredOutlets();
            updateFilterInfo(filtered.length, Object.keys(outlets).length);
        }

        function displayFilteredOutlets() {
            const countElement = document.getElementById('outletCount');
            const countElementDesktop = document.getElementById('outletCountDesktop');
            const filteredEntries = Object.entries(filteredOutlets);
            
            // Update both mobile and desktop counters
            if (countElement) countElement.textContent = filteredEntries.length;
            if (countElementDesktop) countElementDesktop.textContent = filteredEntries.length;
            
            // Load Desktop Table
            loadOutletTable(filteredEntries);
            
            // Load Mobile Grid
            loadOutletGrid(filteredEntries);
        }

        function updateFilterInfo(filteredCount, totalCount) {
            const filterInfo = document.getElementById('filterInfo');
            
            if (filteredCount === totalCount) {
                filterInfo.style.display = 'none';
            } else {
                filterInfo.style.display = 'block';
                filterInfo.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">
                            üìä Hi·ªÉn th·ªã ${filteredCount}/${totalCount} outlet
                        </span>
                        ${filteredCount === 0 ? '<span class="text-orange-600">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y outlet n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc</span>' : ''}
                    </div>
                `;
            }
        }

        function clearFilters() {
            document.getElementById('searchOutletCode').value = '';
            document.getElementById('filterArea').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('sortBy').value = 'code-asc';
            
            // Reset to show all outlets
            filteredOutlets = outlets;
            loadOutletList();
        }

        function loadOutletList() {
            // Initialize filtered outlets with all outlets
            filteredOutlets = outlets;
            
            const countElement = document.getElementById('outletCount');
            const countElementDesktop = document.getElementById('outletCountDesktop');
            const outletEntries = Object.entries(outlets);
            
            // Update both mobile and desktop counters
            if (countElement) countElement.textContent = outletEntries.length;
            if (countElementDesktop) countElementDesktop.textContent = outletEntries.length;
            
            // Load Desktop Table
            loadOutletTable(outletEntries);
            
            // Load Mobile Grid
            loadOutletGrid(outletEntries);
            
            // Load pending outlets sidebar
            loadPendingOutlets();
        }

        function loadOutletTable(outletEntries) {
            const tbody = document.getElementById('outletTableBody');
            tbody.innerHTML = '';
            
            for (const [code, outlet] of outletEntries) {
                const totalRequests = outlet.requests ? outlet.requests.length : 0;
                const pendingRequests = outlet.requests ? outlet.requests.filter(r => !r.completed).length : 0;
                const needsEditCount = outlet.requests ? outlet.requests.filter(r => {
                    return r.editHistory && r.editHistory.length > 0 && 
                           r.editHistory.some(edit => !edit.isFixed);
                }).length : 0;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer transition-colors duration-200';
                row.onclick = () => viewOutletDetail(code);
                
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm font-mono text-blue-600">${code}</div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm font-semibold text-gray-900">${outlet.name}</div>
                        <div class="text-xs text-gray-500 truncate max-w-xs">${outlet.address || ''}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${outlet.area}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-center">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                            ${totalRequests}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-center">
                        ${pendingRequests > 0 ? 
                            `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                                ${pendingRequests}
                            </span>` : 
                            `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                0
                            </span>`
                        }
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="event.stopPropagation(); viewOutletDetail('${code}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-xs btn-hover transition-all duration-300" title="Xem chi ti·∫øt">
                                Xem
                            </button>
                            ${checkPermission('view') ? `
                                <button onclick="event.stopPropagation(); requestEditOutlet('${code}')" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-xs btn-hover transition-all duration-300" title="Y√™u c·∫ßu ch·ªânh s·ª≠a outlet">
                                    ‚úèÔ∏è S·ª≠a
                                </button>
                                <button onclick="event.stopPropagation(); requestDeleteOutlet('${code}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-xs btn-hover transition-all duration-300" title="Y√™u c·∫ßu x√≥a outlet">
                                    üóëÔ∏è X√≥a
                                </button>
                            ` : ''}
                            ${checkPermission('manage') ? `
                                <button onclick="event.stopPropagation(); adminEditOutlet('${code}')" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded text-xs btn-hover transition-all duration-300" title="Admin ch·ªânh s·ª≠a outlet">
                                    üîß Admin
                                </button>
                                <button onclick="event.stopPropagation(); deleteOutlet('${code}')" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-xs btn-hover transition-all duration-300" title="X√≥a vƒ©nh vi·ªÖn outlet">
                                    üóëÔ∏è X√≥a VV
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            }
        }

        function loadOutletGrid(outletEntries) {
            const container = document.getElementById('outletGridContainer');
            container.innerHTML = '';
            
            for (const [code, outlet] of outletEntries) {
                const totalRequests = outlet.requests ? outlet.requests.length : 0;
                const pendingRequests = outlet.requests ? outlet.requests.filter(r => !r.completed).length : 0;
                
                const card = document.createElement('div');
                card.className = 'bg-gradient-to-br from-white to-blue-50 border border-blue-200 rounded-lg p-4 hover:shadow-lg cursor-pointer transition-all duration-300 hover:border-blue-400';
                card.onclick = () => viewOutletDetail(code);
                
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 text-sm mb-1 truncate">${outlet.name}</h4>
                            <p class="text-xs font-mono text-blue-600 mb-1">${code}</p>
                            <p class="text-xs text-gray-600">${outlet.area}</p>
                        </div>
                        <div class="flex flex-col items-end space-y-1">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold">
                                ${totalRequests}
                            </span>
                            ${pendingRequests > 0 ? 
                                `<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-semibold">
                                    ${pendingRequests}
                                </span>` : 
                                `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">
                                    0
                                </span>`
                            }
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-3">
                        <div class="flex items-center justify-between">
                            <button onclick="event.stopPropagation(); viewOutletDetail('${code}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-xs btn-hover transition-all duration-300 touch-btn">
                                Xem Chi Ti·∫øt
                            </button>
                            ${checkPermission('view') ? `
                                <div class="flex space-x-1">
                                    <button onclick="event.stopPropagation(); requestEditOutlet('${code}')" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1.5 rounded text-xs btn-hover transition-all duration-300 touch-btn" title="Y√™u c·∫ßu ch·ªânh s·ª≠a outlet">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="event.stopPropagation(); requestDeleteOutlet('${code}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1.5 rounded text-xs btn-hover transition-all duration-300 touch-btn" title="Y√™u c·∫ßu x√≥a outlet">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            ` : ''}
                            ${checkPermission('manage') ? `
                                <div class="flex space-x-1">
                                    <button onclick="event.stopPropagation(); adminEditOutlet('${code}')" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1.5 rounded text-xs btn-hover transition-all duration-300 touch-btn" title="Admin ch·ªânh s·ª≠a outlet">
                                        üîß
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteOutlet('${code}')" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1.5 rounded text-xs btn-hover transition-all duration-300 touch-btn" title="X√≥a vƒ©nh vi·ªÖn outlet">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            }
        }

        function loadPendingOutlets() {
            const pendingList = document.getElementById('pendingOutletsList');
            const pendingListDesktop = document.getElementById('pendingOutletsListDesktop');
            const pendingListOverlay = document.getElementById('pendingOutletsListOverlay');
            const countElement = document.getElementById('pendingOutletCount');
            const countElementDesktop = document.getElementById('pendingOutletCountDesktop');
            const countElementOverlay = document.getElementById('pendingOutletCountOverlay');
            const noOutletsElement = document.getElementById('noPendingOutlets');
            const noOutletsElementDesktop = document.getElementById('noPendingOutletsDesktop');
            const noOutletsElementOverlay = document.getElementById('noPendingOutletsOverlay');
            
            // Clear all lists (mobile, desktop, overlay)
            if (pendingList) pendingList.innerHTML = '';
            if (pendingListDesktop) pendingListDesktop.innerHTML = '';
            if (pendingListOverlay) pendingListOverlay.innerHTML = '';
            
            const pendingOutlets = [];
            
            // Find outlets with pending requests or requests needing edits
            for (const [code, outlet] of Object.entries(outlets)) {
                const allRequests = outlet.requests || [];
                const pendingRequests = allRequests.filter(r => !r.completed);
                
                // T√¨m c√°c y√™u c·∫ßu c·∫ßn ch·ªânh s·ª≠a (c√≥ editHistory v√† c√≥ edit ch∆∞a ƒë∆∞·ª£c fix)
                const needsEditRequests = allRequests.filter(r => {
                    if (!r.editHistory || r.editHistory.length === 0) return false;
                    
                    // Ki·ªÉm tra xem c√≥ edit n√†o ch∆∞a ƒë∆∞·ª£c fix kh√¥ng
                    return r.editHistory.some(edit => !edit.isFixed);
                });
                
                // ƒê·∫øm ri√™ng c√°c y√™u c·∫ßu ƒë√£ ho√†n th√†nh nh∆∞ng c·∫ßn s·ª≠a
                const completedButNeedsEdit = allRequests.filter(r => {
                    return r.completed && r.editHistory && r.editHistory.length > 0 && 
                           r.editHistory.some(edit => !edit.isFixed);
                });
                
                const totalIssues = pendingRequests.length + needsEditRequests.length;
                
                if (totalIssues > 0) {
                    // Find oldest issue (either pending request or unfixed edit)
                    let oldestIssue = null;
                    let oldestDate = null;
                    
                    // Check pending requests
                    if (pendingRequests.length > 0) {
                        const oldestPending = pendingRequests.sort((a, b) => parseVietnameseDate(a.createdAt) - parseVietnameseDate(b.createdAt))[0];
                        oldestIssue = { type: 'pending', request: oldestPending };
                        oldestDate = parseVietnameseDate(oldestPending.createdAt);
                    }
                    
                    // Check edit requests
                    if (needsEditRequests.length > 0) {
                        needsEditRequests.forEach(request => {
                            const unfixedEdits = request.editHistory.filter(edit => !edit.isFixed);
                            if (unfixedEdits.length > 0) {
                                const oldestEdit = unfixedEdits.sort((a, b) => parseVietnameseDate(a.timestamp) - parseVietnameseDate(b.timestamp))[0];
                                const editDate = parseVietnameseDate(oldestEdit.timestamp);
                                
                                if (!oldestDate || editDate < oldestDate) {
                                    oldestIssue = { type: 'edit', request: request, edit: oldestEdit };
                                    oldestDate = editDate;
                                }
                            }
                        });
                    }
                    
                    pendingOutlets.push({
                        code,
                        outlet,
                        pendingCount: pendingRequests.length,
                        editCount: needsEditRequests.length,
                        completedButNeedsEditCount: completedButNeedsEdit.length,
                        totalRequests: allRequests.length,
                        totalIssues: totalIssues,
                        oldestIssue: oldestIssue,
                        oldestDate: oldestDate
                    });
                }
            }
            
            // Update all counts (mobile, desktop, overlay)
            if (countElement) countElement.textContent = pendingOutlets.length;
            if (countElementDesktop) countElementDesktop.textContent = pendingOutlets.length;
            if (countElementOverlay) countElementOverlay.textContent = pendingOutlets.length;
            
            if (pendingOutlets.length === 0) {
                // Show no outlets message for all views
                if (noOutletsElement) noOutletsElement.style.display = 'block';
                if (noOutletsElementDesktop) noOutletsElementDesktop.style.display = 'block';
                if (noOutletsElementOverlay) noOutletsElementOverlay.style.display = 'block';
                if (pendingList) pendingList.style.display = 'none';
                if (pendingListDesktop) pendingListDesktop.style.display = 'none';
                if (pendingListOverlay) pendingListOverlay.style.display = 'none';
            } else {
                // Hide no outlets message for all views
                if (noOutletsElement) noOutletsElement.style.display = 'none';
                if (noOutletsElementDesktop) noOutletsElementDesktop.style.display = 'none';
                if (noOutletsElementOverlay) noOutletsElementOverlay.style.display = 'none';
                if (pendingList) pendingList.style.display = 'block';
                if (pendingListDesktop) pendingListDesktop.style.display = 'block';
                if (pendingListOverlay) pendingListOverlay.style.display = 'block';
                
                // Sort by oldest issue first (most urgent)
                pendingOutlets.sort((a, b) => a.oldestDate - b.oldestDate);
                
                pendingOutlets.forEach(item => {
                    // Different styling based on issue type
                    const hasEdits = item.editCount > 0;
                    const hasPending = item.pendingCount > 0;
                    
                    let cardClass = '';
                    if (hasEdits && hasPending) {
                        cardClass = 'bg-gradient-to-r from-red-50 to-orange-50 border-l-4 border-red-500 p-4 rounded-lg hover:shadow-md transition-all duration-300 cursor-pointer';
                    } else if (hasEdits) {
                        cardClass = 'bg-gradient-to-r from-orange-50 to-yellow-50 border-l-4 border-orange-500 p-4 rounded-lg hover:shadow-md transition-all duration-300 cursor-pointer';
                    } else {
                        cardClass = 'bg-gradient-to-r from-red-50 to-orange-50 border-l-4 border-red-400 p-4 rounded-lg hover:shadow-md transition-all duration-300 cursor-pointer';
                    }
                    
                    // Create mobile version
                    const divMobile = document.createElement('div');
                    divMobile.className = cardClass;
                    divMobile.onclick = () => viewOutletDetail(item.code);
                    
                    // Create desktop version
                    const divDesktop = document.createElement('div');
                    divDesktop.className = cardClass;
                    divDesktop.onclick = () => viewOutletDetail(item.code);
                    
                    // Create overlay version (for mobile overlay tab)
                    const divOverlay = document.createElement('div');
                    divOverlay.className = cardClass;
                    divOverlay.onclick = () => {
                        closeMobilePendingOverlay();
                        viewOutletDetail(item.code);
                    };
                    
                    // Calculate days since oldest issue
                    const daysSince = Math.floor((new Date() - item.oldestDate) / (1000 * 60 * 60 * 24));
                    const urgencyColor = daysSince > 7 ? 'text-red-600' : daysSince > 3 ? 'text-orange-600' : 'text-yellow-600';
                    const urgencyIcon = daysSince > 7 ? 'üö®' : daysSince > 3 ? '‚ö†Ô∏è' : '‚è∞';
                    
                    // Issue type indicator
                    let issueTypeText = '';
                    let issueIcon = '';
                    if (hasEdits && hasPending) {
                        issueTypeText = `${item.pendingCount} ch∆∞a xong, ${item.editCount} c·∫ßn s·ª≠a`;
                        issueIcon = 'üî•';
                    } else if (hasEdits) {
                        const completedNeedsEdit = item.completedButNeedsEditCount || 0;
                        if (completedNeedsEdit > 0) {
                            issueTypeText = `${item.editCount} c·∫ßn ch·ªânh s·ª≠a (${completedNeedsEdit} ƒë√£ xong)`;
                        } else {
                            issueTypeText = `${item.editCount} c·∫ßn ch·ªânh s·ª≠a`;
                        }
                        issueIcon = 'üîß';
                    } else {
                        issueTypeText = `${item.pendingCount} ch∆∞a ho√†n th√†nh`;
                        issueIcon = '‚è≥';
                    }
                    
                    const cardContent = `
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 text-sm">${item.outlet.name}</h4>
                                <p class="text-xs text-gray-600 font-mono">${item.code}</p>
                                <p class="text-xs text-gray-500">${item.outlet.area}</p>
                            </div>
                            <div class="text-right">
                                <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-semibold">
                                    ${item.totalIssues}/${item.totalRequests}
                                </span>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <div class="flex items-center space-x-1 text-xs">
                                <span>${issueIcon}</span>
                                <span class="text-gray-700">${issueTypeText}</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between text-xs">
                            <div class="flex items-center space-x-1 ${urgencyColor}">
                                <span>${urgencyIcon}</span>
                                <span>C≈© nh·∫•t: ${item.oldestDate.toLocaleString('vi-VN', {
                                    hour: '2-digit',
                                    minute: '2-digit', 
                                    second: '2-digit',
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric'
                                }).replace(',', '')}</span>
                            </div>
                            <button class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs btn-hover transition-all duration-300" onclick="event.stopPropagation(); viewOutletDetail('${item.code}')">
                                Xem ‚Üí
                            </button>
                        </div>
                        
                        <div class="mt-2 text-xs text-gray-600">
                            <div class="truncate">
                                ${item.oldestIssue.type === 'edit' ? 
                                    `üîß S·ª≠a: ${item.oldestIssue.request.requesterName}` : 
                                    `üë§ ${item.oldestIssue.request.requesterName}`
                                }
                            </div>
                        </div>
                    `;
                    
                    // Set content for all versions
                    divMobile.innerHTML = cardContent;
                    divDesktop.innerHTML = cardContent;
                    divOverlay.innerHTML = cardContent;
                    
                    // Append to respective containers
                    if (pendingList) pendingList.appendChild(divMobile);
                    if (pendingListDesktop) pendingListDesktop.appendChild(divDesktop);
                    if (pendingListOverlay) pendingListOverlay.appendChild(divOverlay);
                });
            }
        }

        // Helper function to parse Vietnamese date format
        function parseVietnameseDate(dateString) {
            try {
                // Handle multiple formats
                let cleanDate = dateString.replace(',', '').trim();
                
                // Check if format is already "hh:mm:ss dd/mm/yyyy"
                const timeFirstPattern = /^(\d{1,2}):(\d{2}):(\d{2})\s+(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
                const timeFirstMatch = cleanDate.match(timeFirstPattern);
                
                if (timeFirstMatch) {
                    const [, hour, minute, second, day, month, year] = timeFirstMatch;
                    return new Date(parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute), parseInt(second));
                }
                
                // Handle format: "15/01/2024 14:30:00" or "15/01/2024, 14:30:00"
                const parts = cleanDate.split(' ');
                
                if (parts.length >= 2) {
                    const datePart = parts[0]; // "15/01/2024"
                    const timePart = parts[1]; // "14:30:00"
                    
                    const dateComponents = datePart.split('/');
                    const timeComponents = timePart.split(':');
                    
                    if (dateComponents.length === 3 && timeComponents.length >= 2) {
                        const day = parseInt(dateComponents[0]);
                        const month = parseInt(dateComponents[1]) - 1; // Month is 0-indexed
                        const year = parseInt(dateComponents[2]);
                        const hour = parseInt(timeComponents[0]);
                        const minute = parseInt(timeComponents[1]);
                        const second = timeComponents[2] ? parseInt(timeComponents[2]) : 0;
                        
                        return new Date(year, month, day, hour, minute, second);
                    }
                }
                
                // Fallback: try to parse as is
                return new Date(dateString);
            } catch (error) {
                console.error('Error parsing date:', dateString, error);
                return new Date(); // Return current date as fallback
            }
        }

        function searchOutlet(event) {
            // Auto-filter as user types
            if (event && event.type === 'keyup') {
                filterOutlets();
                return;
            }
            
            // Manual search button click
            const searchValue = document.getElementById('searchOutletCode').value.trim();
            if (!searchValue) {
                alert('Vui l√≤ng nh·∫≠p Outlet Code ho·∫∑c T√™n Outlet');
                return;
            }
            
            // First try exact code match
            if (outlets[searchValue]) {
                viewOutletDetail(searchValue);
                return;
            }
            
            // Then try to find by name or partial code
            const searchLower = searchValue.toLowerCase();
            const matches = [];
            
            for (const [code, outlet] of Object.entries(outlets)) {
                if (code.includes(searchValue) || outlet.name.toLowerCase().includes(searchLower)) {
                    matches.push({ code, outlet });
                }
            }
            
            if (matches.length === 1) {
                // Single match found
                viewOutletDetail(matches[0].code);
            } else if (matches.length > 1) {
                // Multiple matches found
                let message = `T√¨m th·∫•y ${matches.length} k·∫øt qu·∫£:\n\n`;
                matches.forEach((match, index) => {
                    message += `${index + 1}. ${match.outlet.name} (${match.code}) - ${match.outlet.area}\n`;
                });
                message += `\nVui l√≤ng nh·∫≠p ch√≠nh x√°c h∆°n ho·∫∑c s·ª≠ d·ª•ng b·ªô l·ªçc.`;
                alert(message);
            } else {
                // No matches found
                if (/^\d{8}$/.test(searchValue)) {
                    // If search value is exactly 8 digits, offer to create new outlet
                    if (confirm(`Kh√¥ng t√¨m th·∫•y outlet v·ªõi code "${searchValue}".\n\nB·∫°n c√≥ mu·ªën t·∫°o outlet m·ªõi v·ªõi code "${searchValue}" kh√¥ng?`)) {
                        document.getElementById('newOutletCode').value = searchValue;
                        showCreateOutlet();
                    }
                } else if (/^\d+$/.test(searchValue)) {
                    alert(`Kh√¥ng t√¨m th·∫•y outlet v·ªõi code "${searchValue}".\n\n‚ö†Ô∏è L∆∞u √Ω: Outlet Code ph·∫£i c√≥ ƒë√∫ng 8 ch·ªØ s·ªë.\nCode b·∫°n nh·∫≠p c√≥ ${searchValue.length} ch·ªØ s·ªë.\n\nH√£y th·ª≠ t√¨m ki·∫øm v·ªõi code 8 s·ªë ho·∫∑c t√™n outlet.`);
                } else {
                    alert(`Kh√¥ng t√¨m th·∫•y outlet v·ªõi t·ª´ kh√≥a "${searchValue}".\n\nH√£y th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c s·ª≠ d·ª•ng b·ªô l·ªçc b√™n d∆∞·ªõi.`);
                }
            }
        }

        function viewOutletDetail(code) {
            currentOutletCode = code;
            const outlet = outlets[code];
            
            document.getElementById('outletDetailTitle').textContent = `Chi Ti·∫øt Outlet: ${outlet.name}`;
            document.getElementById('outletDetailInfo').innerHTML = `
                <div>Code: ${code} | Khu v·ª±c: ${outlet.area}</div>
                <div class="text-sm mt-1">üìç ${outlet.address || 'Ch∆∞a c√≥ ƒë·ªãa ch·ªâ'}</div>
            `;
            
            // Show modal
            document.getElementById('outletDetailModal').style.display = 'flex';
            
            loadRequestList(code);
            
            // Highlight selected row
            highlightSelectedOutlet(code);
        }

        function closeOutletDetail() {
            currentOutletCode = null;
            document.getElementById('outletDetailModal').style.display = 'none';
            
            // Remove highlight from all rows
            document.querySelectorAll('#outletTableBody tr').forEach(row => {
                row.classList.remove('bg-blue-100', 'border-l-4', 'border-blue-500');
            });
        }

        function highlightSelectedOutlet(code) {
            // Remove previous highlights
            document.querySelectorAll('#outletTableBody tr').forEach(row => {
                row.classList.remove('bg-blue-100', 'border-l-4', 'border-blue-500');
            });
            
            // Add highlight to selected row
            const rows = document.querySelectorAll('#outletTableBody tr');
            rows.forEach(row => {
                const codeCell = row.querySelector('td:first-child');
                if (codeCell && codeCell.textContent === code) {
                    row.classList.add('bg-blue-100', 'border-l-4', 'border-blue-500');
                }
            });
        }



        function loadRequestList(code) {
            const countElement = document.getElementById('requestCount');
            const requests = outlets[code].requests || [];
            countElement.textContent = requests.length;
            
            // Load Desktop Table
            loadRequestTable(requests);
            
            // Load Mobile Grid
            loadRequestGrid(requests);
        }

        function loadRequestTable(requests) {
            const tbody = document.getElementById('requestTableBody');
            tbody.innerHTML = '';
            
            requests.forEach((request, index) => {
                // Get item count and brands for display
                const itemCount = request.requestItems ? request.requestItems.length : 0;
                const brands = request.requestItems ? [...new Set(request.requestItems.map(item => item.brand))] : (request.brand ? [request.brand] : ['N/A']);
                const displayBrands = brands.join(', ');
                
                // Calculate edit status
                const hasEdits = request.editHistory && request.editHistory.length > 0;
                const hasUnfixedEdits = hasEdits && request.editHistory.some(edit => !edit.isFixed);
                
                const row = document.createElement('tr');
                const isCancelRequested = request.cancelRequested && !request.cancelApproved;
                const isCancelled = request.cancelRequested && request.cancelApproved;
                let rowClass = 'hover:bg-gray-50 transition-colors duration-200';
                
                if (isCancelled) {
                    rowClass += ' bg-gray-100 opacity-60';
                } else if (isCancelRequested) {
                    rowClass += ' bg-red-50 opacity-75';
                } else if (request.completed) {
                    rowClass += ' bg-green-50';
                } else {
                    rowClass += ' bg-yellow-50';
                }
                
                row.className = rowClass;
                
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="request-checkbox" value="${request.id}">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800">
                                #${index + 1}
                            </span>
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm font-semibold text-gray-900">${request.requesterName}</div>
                        <div class="text-xs text-gray-500">${request.createdAt}</div>
                        ${request.completed ? `<div class="text-xs text-green-600">‚úÖ ${request.completedAt}</div>` : ''}
                    </td>
                    <td class="px-4 py-4">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            ${itemCount} h·∫°ng m·ª•c
                        </span>
                    </td>
                    <td class="px-4 py-4">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                            ${displayBrands}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-center">
                        <div class="flex flex-col items-center space-y-1">
                            ${isCancelled ? 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800">
                                    ‚ùå ƒê√£ h·ªßy
                                </span>` :
                                isCancelRequested ? 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                                    üö´ Y√™u c·∫ßu h·ªßy
                                </span>` :
                                request.completed ? 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                    ‚úÖ Ho√†n th√†nh
                                </span>` : 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">
                                    ‚è≥ Ch∆∞a xong
                                </span>`
                            }
                            ${hasUnfixedEdits ? 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                                    üîß C·∫ßn s·ª≠a
                                </span>` : ''
                            }
                            ${hasEdits && !hasUnfixedEdits ? 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                                    ‚úÖ ƒê√£ s·ª≠a
                                </span>` : ''
                            }
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="viewRequestDetail(${request.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-xs btn-hover transition-all duration-300" title="Xem chi ti·∫øt">
                                Xem
                            </button>
                            <button onclick="editRequest(${request.id})" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-xs btn-hover transition-all duration-300" title="Ch·ªânh s·ª≠a y√™u c·∫ßu">
                                S·ª≠a (${hasEdits ? request.editHistory.length : 0})
                            </button>
                            ${checkPermission('view') ? `
                                <button onclick="requestCancelRequest(${request.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-xs btn-hover transition-all duration-300" title="Y√™u c·∫ßu h·ªßy">
                                    H·ªßy
                                </button>
                            ` : ''}
                            ${!request.completed ? 
                                (checkPermission('upload') ? 
                                    `<button onclick="uploadMaquette(${request.id})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-xs btn-hover transition-all duration-300" title="Upload maquette">
                                        Upload
                                    </button>` : 
                                    '<span class="text-xs text-gray-500" title="Ch·ªù admin upload">‚è≥</span>'
                                ) : 
                                `<div class="flex space-x-1">
                                    <button onclick="viewMaquette(${request.id})" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded text-xs btn-hover transition-all duration-300" title="Xem maquette">
                                        Xem
                                    </button>
                                    ${checkPermission('upload') ? `
                                        <button onclick="editMaquette(${request.id})" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-xs btn-hover transition-all duration-300" title="Ch·ªânh s·ª≠a maquette">
                                            S·ª≠a
                                        </button>
                                    ` : ''}
                                </div>`
                            }
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function loadRequestGrid(requests) {
            const container = document.getElementById('requestGridContainer');
            container.innerHTML = '';
            
            requests.forEach((request, index) => {
                // Get item count and brands for display
                const itemCount = request.requestItems ? request.requestItems.length : 0;
                const brands = request.requestItems ? [...new Set(request.requestItems.map(item => item.brand))] : (request.brand ? [request.brand] : ['N/A']);
                const displayBrands = brands.join(', ');
                
                // Calculate edit status
                const hasEdits = request.editHistory && request.editHistory.length > 0;
                const hasUnfixedEdits = hasEdits && request.editHistory.some(edit => !edit.isFixed);
                
                const card = document.createElement('div');
                const isCancelRequested = request.cancelRequested && !request.cancelApproved;
                const isCancelled = request.cancelRequested && request.cancelApproved;
                
                let cardClass = 'bg-gradient-to-br from-white border rounded-lg p-4 hover:shadow-lg transition-all duration-300';
                
                if (isCancelled) {
                    cardClass += ' to-gray-50 border-gray-200 opacity-60';
                } else if (isCancelRequested) {
                    cardClass += ' to-red-50 border-red-200 opacity-75';
                } else if (request.completed) {
                    cardClass += ' to-green-50 border-green-200';
                } else {
                    cardClass += ' to-yellow-50 border-yellow-200';
                }
                
                card.className = cardClass;
                
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="request-checkbox" value="${request.id}">
                            <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-semibold">
                                #${index + 1}
                            </span>
                        </div>
                        <div class="flex flex-col items-end space-y-1">
                            ${isCancelled ? 
                                `<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-semibold">
                                    ‚ùå ƒê√£ h·ªßy
                                </span>` :
                                isCancelRequested ? 
                                `<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-semibold">
                                    üö´ Y√™u c·∫ßu h·ªßy
                                </span>` :
                                request.completed ? 
                                `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">
                                    ‚úÖ Ho√†n th√†nh
                                </span>` : 
                                `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-semibold">
                                    ‚è≥ Ch∆∞a xong
                                </span>`
                            }
                            ${hasUnfixedEdits ? 
                                `<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-semibold">
                                    üîß C·∫ßn s·ª≠a
                                </span>` : ''
                            }
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h4 class="font-bold text-gray-800 text-sm mb-2">üë§ ${request.requesterName}</h4>
                        <div class="space-y-1">
                            <div class="flex items-center space-x-2">
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">
                                    ${itemCount} h·∫°ng m·ª•c
                                </span>
                                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs">
                                    ${displayBrands}
                                </span>
                            </div>
                            <p class="text-xs text-gray-600">üìÖ ${request.createdAt}</p>
                            ${request.completed ? 
                                `<p class="text-xs text-green-600">‚úÖ ${request.completedAt}</p>` : ''
                            }
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-3">
                        <div class="flex items-center justify-between mb-2">
                            <button onclick="editRequest(${request.id})" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs btn-hover transition-all duration-300 touch-btn" title="Ch·ªânh s·ª≠a y√™u c·∫ßu">
                                S·ª≠a (${hasEdits ? request.editHistory.length : 0})
                            </button>
                            ${hasEdits ? 
                                `<span class="text-xs ${hasUnfixedEdits ? 'text-red-600' : 'text-green-600'}">
                                    ${hasUnfixedEdits ? 'üîß C·∫ßn s·ª≠a' : '‚úÖ ƒê√£ s·ª≠a'}
                                </span>` : 
                                '<span class="text-xs text-gray-500">Ch∆∞a c√≥ s·ª≠a</span>'
                            }
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button onclick="viewRequestDetail(${request.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs btn-hover transition-all duration-300 touch-btn">
                                Chi Ti·∫øt
                            </button>
                            ${checkPermission('view') ? `
                                <button onclick="requestCancelRequest(${request.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs btn-hover transition-all duration-300 touch-btn" title="Y√™u c·∫ßu h·ªßy">
                                    H·ªßy
                                </button>
                            ` : ''}
                            ${!request.completed ? 
                                (checkPermission('upload') ? 
                                    `<button onclick="uploadMaquette(${request.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs btn-hover transition-all duration-300 touch-btn">
                                        Upload
                                    </button>` : 
                                    '<span class="text-xs text-gray-500">Ch·ªù admin upload</span>'
                                ) : 
                                `<div class="flex gap-1">
                                    <button onclick="viewMaquette(${request.id})" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs btn-hover transition-all duration-300 touch-btn">
                                        Xem
                                    </button>
                                    ${checkPermission('upload') ? `
                                        <button onclick="editMaquette(${request.id})" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs btn-hover transition-all duration-300 touch-btn" title="Ch·ªânh s·ª≠a maquette">
                                            S·ª≠a
                                        </button>
                                    ` : ''}
                                </div>`
                            }
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.request-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function showCreateOutlet() {
            if (!checkPermission('create') && !checkPermission('manage')) {
                alert('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn t·∫°o outlet m·ªõi!');
                return;
            }
            document.getElementById('createOutletModal').style.display = 'flex';
        }

        function validateOutletCodeInput(input) {
            // Remove any non-numeric characters
            const numericValue = input.value.replace(/[^0-9]/g, '');
            
            // Limit to 8 digits maximum
            const limitedValue = numericValue.slice(0, 8);
            
            // Update input value if it was changed
            if (input.value !== limitedValue) {
                input.value = limitedValue;
                
                // Show warning message temporarily
                const resultDiv = document.getElementById('codeCheckResult');
                resultDiv.innerHTML = `
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-orange-500">‚ö†Ô∏è</span>
                            <div class="text-orange-700 font-semibold">ƒê√£ x√≥a k√Ω t·ª± kh√¥ng h·ª£p l·ªá! Ch·ªâ ƒë∆∞·ª£c nh·∫≠p s·ªë v√† t·ªëi ƒëa 8 ch·ªØ s·ªë.</div>
                        </div>
                    </div>
                `;
                resultDiv.style.display = 'block';
                
                // Hide warning after 3 seconds
                setTimeout(() => {
                    if (resultDiv.innerHTML.includes('ƒê√£ x√≥a k√Ω t·ª± kh√¥ng h·ª£p l·ªá')) {
                        resultDiv.style.display = 'none';
                    }
                }, 3000);
            }
            
            // Show real-time validation status
            const resultDiv = document.getElementById('codeCheckResult');
            if (limitedValue.length > 0 && limitedValue.length < 8) {
                resultDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-yellow-500">‚è≥</span>
                            <div class="text-yellow-700 font-semibold">ƒê√£ nh·∫≠p ${limitedValue.length}/8 ch·ªØ s·ªë. C·∫ßn th√™m ${8 - limitedValue.length} ch·ªØ s·ªë n·ªØa.</div>
                        </div>
                    </div>
                `;
                resultDiv.style.display = 'block';
            } else if (limitedValue.length === 8) {
                // Check if code exists when exactly 8 digits
                checkOutletCodeExists(limitedValue);
            } else if (limitedValue.length === 0) {
                resultDiv.style.display = 'none';
            }
        }

        function checkOutletCodeExists(code) {
            const resultDiv = document.getElementById('codeCheckResult');
            
            if (!code || code.trim() === '') {
                resultDiv.style.display = 'none';
                return;
            }
            
            code = code.trim();
            
            // Check if code contains only numbers
            if (!/^\d+$/.test(code)) {
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-red-500">‚ùå</span>
                            <div>
                                <div class="text-red-700 font-semibold">Code kh√¥ng h·ª£p l·ªá!</div>
                                <div class="text-red-600 text-xs mt-1">
                                    Outlet Code ch·ªâ ƒë∆∞·ª£c ch·ª©a s·ªë (0-9) v√† ph·∫£i ƒë√∫ng 8 ch·ªØ s·ªë
                                </div>
                                <div class="text-red-600 text-xs">
                                    V√≠ d·ª• h·ª£p l·ªá: 10000001, 20000001, 12345678
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return false;
            }
            
            // Check if code has exactly 8 digits
            if (code.length !== 8) {
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-red-500">‚ùå</span>
                            <div>
                                <div class="text-red-700 font-semibold">Code ph·∫£i c√≥ ƒë√∫ng 8 ch·ªØ s·ªë!</div>
                                <div class="text-red-600 text-xs mt-1">
                                    B·∫°n ƒë√£ nh·∫≠p ${code.length} ch·ªØ s·ªë, c·∫ßn ${code.length < 8 ? 'th√™m ' + (8 - code.length) : 'b·ªõt ' + (code.length - 8)} ch·ªØ s·ªë
                                </div>
                                <div class="text-red-600 text-xs">
                                    V√≠ d·ª• h·ª£p l·ªá: 10000001, 20000001, 12345678
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return false;
            }
            
            if (outlets[code]) {
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-red-500">‚ùå</span>
                            <div>
                                <div class="text-red-700 font-semibold">Code ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!</div>
                                <div class="text-red-600 text-xs mt-1">
                                    Outlet: "${outlets[code].name}" - ${outlets[code].area}
                                </div>
                                <div class="text-red-600 text-xs">
                                    Vui l√≤ng nh·∫≠p code kh√°c ho·∫∑c t√¨m ki·∫øm outlet n√†y ·ªü trang ch√≠nh
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return false;
            } else {
                resultDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-green-500">‚úÖ</span>
                            <div class="text-green-700 font-semibold">Code h·ª£p l·ªá v√† kh·∫£ d·ª•ng! C√≥ th·ªÉ t·∫°o outlet m·ªõi.</div>
                        </div>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return true;
            }
        }

        function hideCreateOutlet() {
            document.getElementById('createOutletModal').style.display = 'none';
            document.getElementById('createOutletForm').reset();
            document.getElementById('codeCheckResult').style.display = 'none';
        }

        function showNewRequestForm() {
            if (!checkPermission('create')) {
                if (currentUser && currentUser.position === 'SS') {
                    alert('‚ùå Ch·ª©c v·ª• SS kh√¥ng c√≥ quy·ªÅn t·∫°o y√™u c·∫ßu m·ªõi!\n\nCh·ªâ c√≥ SR/TBA m·ªõi ƒë∆∞·ª£c t·∫°o y√™u c·∫ßu. B·∫°n c√≥ th·ªÉ xem v√† comment ch·ªânh s·ª≠a c√°c y√™u c·∫ßu hi·ªán c√≥.');
                } else {
                    alert('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn t·∫°o y√™u c·∫ßu m·ªõi!');
                }
                return;
            }
            if (!currentOutletCode) {
                alert('Vui l√≤ng ch·ªçn outlet tr∆∞·ªõc');
                return;
            }
            
            // T·ª± ƒë·ªông ƒëi·ªÅn t√™n ng∆∞·ªùi y√™u c·∫ßu
            if (currentUser && currentUser.name) {
                document.getElementById('requesterName').value = currentUser.name;
            }
            
            // T·ª± ƒë·ªông ƒëi·ªÅn ƒë·ªãa ch·ªâ t·ª´ outlet
            const outlet = outlets[currentOutletCode];
            if (outlet && outlet.address) {
                document.getElementById('requestAddress').value = outlet.address;
            }
            
            document.getElementById('newRequestModal').style.display = 'flex';
            
            // T·ª± ƒë·ªông th√™m h·∫°ng m·ª•c ƒë·∫ßu ti√™n n·∫øu ch∆∞a c√≥
            const container = document.getElementById('requestItemsContainer');
            if (container.children.length === 0) {
                addRequestItem();
            }
        }

        function hideNewRequestForm() {
            document.getElementById('newRequestModal').style.display = 'none';
            document.getElementById('newRequestForm').reset();
            document.getElementById('requestItemsContainer').innerHTML = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').innerHTML = '';
        }

        function addRequestItem() {
            const container = document.getElementById('requestItemsContainer');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'border border-gray-200 rounded p-3 mb-2 request-item';
            itemDiv.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold text-gray-700 text-sm">H·∫°ng M·ª•c</h4>
                    <button type="button" onclick="removeRequestItem(this)" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                        X√≥a
                    </button>
                </div>
                <div class="space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs text-orange-700 mb-1 font-semibold">Lo·∫°i *</label>
                            <select class="w-full px-2 py-1 border-2 border-orange-300 rounded focus:border-orange-500 focus:outline-none item-type text-sm bg-white" onchange="toggleItemFields(this)" required>
                                <option value="B·∫£ng Hi·ªáu">B·∫£ng Hi·ªáu</option>
                                <option value="H·ªôp ƒê√®n">H·ªôp ƒê√®n</option>
                                <option value="Logo">Logo</option>
                                <option value="Kh√°c">Kh√°c</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-orange-700 mb-1 font-semibold">Brand *</label>
                            <select class="w-full px-2 py-1 border-2 border-orange-300 rounded focus:border-orange-500 focus:outline-none item-brand text-sm bg-white" required>
                                <option value="Tiger">Tiger</option>
                                <option value="Heineken">Heineken</option>
                                <option value="Strongbow">Strongbow</option>
                                <option value="Bivina">Bivina</option>
                                <option value="Bia Vi·ªát">Bia Vi·ªát</option>
                                <option value="Shopname">Shopname</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Custom Type Section -->
                    <div class="item-custom-section" style="display: none;">
                        <textarea class="w-full px-2 py-1 border-2 border-orange-300 rounded focus:border-orange-500 focus:outline-none resize-none item-custom-desc text-sm bg-white" rows="2" placeholder="M√¥ t·∫£ y√™u c·∫ßu kh√°c"></textarea>
                    </div>
                    
                    <!-- Size Section -->
                    <div class="item-size-section">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" class="w-full px-2 py-1 border-2 border-orange-300 rounded focus:border-orange-500 focus:outline-none item-width text-sm bg-white" min="0" step="0.1" placeholder="Ngang (m)">
                            <input type="number" class="w-full px-2 py-1 border-2 border-orange-300 rounded focus:border-orange-500 focus:outline-none item-height text-sm bg-white" min="0" step="0.1" placeholder="Cao (m)">
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(itemDiv);
            updateItemNumbers();
        }



        function removeRequestItem(button) {
            button.closest('.request-item').remove();
            updateItemNumbers();
        }

        function updateItemNumbers() {
            const items = document.querySelectorAll('.request-item');
            items.forEach((item, index) => {
                const title = item.querySelector('h4');
                title.textContent = `H·∫°ng M·ª•c ${index + 1}`;
            });
        }

        function toggleItemFields(selectElement) {
            const itemDiv = selectElement.closest('.request-item');
            const type = selectElement.value;
            const customSection = itemDiv.querySelector('.item-custom-section');
            const sizeSection = itemDiv.querySelector('.item-size-section');
            const notesSection = itemDiv.querySelector('.item-notes-section');
            
            customSection.style.display = type === 'Kh√°c' ? 'block' : 'none';
            sizeSection.style.display = ['Logo', 'B·∫£ng Hi·ªáu', 'H·ªôp ƒê√®n'].includes(type) ? 'block' : 'none';
            notesSection.style.display = type === 'Logo' ? 'block' : 'none';
        }

        // Upload Maquette Form submission
        document.getElementById('uploadMaquetteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const notes = document.getElementById('completionNotes').value.trim();
            const fileInput = document.getElementById('maquetteFiles');
            
            // Sync files from input to selectedMaquetteFiles if needed
            if (fileInput.files.length > 0) {
                const inputFiles = Array.from(fileInput.files);
                inputFiles.forEach(file => {
                    const exists = selectedMaquetteFiles.some(f => f.name === file.name && f.size === file.size);
                    if (!exists) {
                        selectedMaquetteFiles.push(file);
                    }
                });
            }
            
            // Final check for files
            if (selectedMaquetteFiles.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 file maquette!');
                return;
            }
            
            // Get file names and data
            const filePromises = selectedMaquetteFiles.map(file => {
                return new Promise((resolve) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            resolve({
                                name: file.name,
                                type: file.type,
                                data: e.target.result
                            });
                        };
                        reader.readAsDataURL(file);
                    } else {
                        resolve({
                            name: file.name,
                            type: file.type,
                            data: null // For non-image files, we just store the name
                        });
                    }
                });
            });
            
            Promise.all(filePromises).then(fileData => {
                // Update request
                const requestIndex = outlets[currentOutletCode].requests.findIndex(r => r.id === currentRequestId);
                if (requestIndex !== -1) {
                    outlets[currentOutletCode].requests[requestIndex].completed = true;
                    outlets[currentOutletCode].requests[requestIndex].completedAt = new Date().toLocaleString('vi-VN');
                    outlets[currentOutletCode].requests[requestIndex].maquetteFiles = fileData.map(f => f.name);
                    outlets[currentOutletCode].requests[requestIndex].maquetteData = fileData;
                    outlets[currentOutletCode].requests[requestIndex].completionNotes = notes;
                    
                    saveData();
                    loadRequestList(currentOutletCode);
                    loadOutletList();
                    hideUploadMaquette();
                    
                    alert('‚úÖ ƒê√£ x√°c nh·∫≠n ho√†n th√†nh y√™u c·∫ßu!');
                }
            });
        });

        // Form submissions
        document.getElementById('createOutletForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const code = document.getElementById('newOutletCode').value.trim();
            const name = document.getElementById('newOutletName').value.trim();
            const address = document.getElementById('newOutletAddress').value.trim();
            const area = document.getElementById('newOutletArea').value;
            
            if (!code) {
                alert('‚ùå Vui l√≤ng nh·∫≠p Outlet Code!');
                return;
            }
            
            if (!address) {
                alert('‚ùå Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ outlet!');
                return;
            }
            
            // Validate code format (must be exactly 8 digits)
            if (!/^\d{8}$/.test(code)) {
                alert('‚ùå Outlet Code kh√¥ng h·ª£p l·ªá!\n\nCode ph·∫£i c√≥ ƒë√∫ng 8 ch·ªØ s·ªë (VD: 10000001, 20000001, 12345678)');
                checkOutletCodeExists(code); // Show the error message
                return;
            }
            
            // Check if code already exists
            if (outlets[code]) {
                alert(`‚ùå Outlet Code "${code}" ƒë√£ t·ªìn t·∫°i!\n\nOutlet: "${outlets[code].name}" - ${outlets[code].area}\n\nVui l√≤ng nh·∫≠p code kh√°c ho·∫∑c t√¨m ki·∫øm outlet n√†y ·ªü trang ch√≠nh.`);
                checkOutletCodeExists(code); // Show the error message
                return;
            }
            
            outlets[code] = {
                name: name,
                address: address,
                area: area,
                requests: []
            };
            
            saveData();
            loadOutletList();
            hideCreateOutlet();
            
            alert(`‚úÖ T·∫°o outlet th√†nh c√¥ng!\n\nOutlet Code: ${code}\nT√™n: ${name}\nƒê·ªãa ch·ªâ: ${address}\nKhu v·ª±c: ${area}`);
        });

        document.getElementById('newRequestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const requesterName = document.getElementById('requesterName').value.trim();
            const address = document.getElementById('requestAddress').value.trim();
            const content = document.getElementById('requestContent').value.trim();
            const imageFiles = document.getElementById('requestImage').files;
            
            // Validate required fields
            if (!requesterName) {
                alert('‚ùå Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi y√™u c·∫ßu!');
                document.getElementById('requesterName').focus();
                return;
            }
            
            if (!address) {
                alert('‚ùå Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ!');
                document.getElementById('requestAddress').focus();
                return;
            }
            
            if (imageFiles.length === 0) {
                alert('‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 h√¨nh ·∫£nh!\n\nüì∑ H∆∞·ªõng d·∫´n:\n‚Ä¢ Up ƒë∆∞·ª£c nhi·ªÅu h√¨nh\n‚Ä¢ Ch·ª•p c·∫≠n n·ªôi dung c≈© (n·∫øu c√≥)\n‚Ä¢ Ch·ª•p to√†n c·∫£nh v·ªã tr√≠');
                document.getElementById('requestImage').focus();
                return;
            }
            
            // Get and validate request items
            const requestItems = [];
            const itemDivs = document.querySelectorAll('.request-item');
            
            if (itemDivs.length === 0) {
                alert('‚ùå Vui l√≤ng th√™m √≠t nh·∫•t 1 h·∫°ng m·ª•c kh·∫£o s√°t!');
                return;
            }
            
            let hasIncompleteItem = false;
            let incompleteItemIndex = -1;
            
            itemDivs.forEach((itemDiv, index) => {
                const type = itemDiv.querySelector('.item-type').value;
                const brand = itemDiv.querySelector('.item-brand').value.trim();
                const width = itemDiv.querySelector('.item-width').value;
                const height = itemDiv.querySelector('.item-height').value;
                const customDesc = itemDiv.querySelector('.item-custom-desc') ? itemDiv.querySelector('.item-custom-desc').value.trim() : '';
                const notes = itemDiv.querySelector('.item-notes') ? itemDiv.querySelector('.item-notes').value.trim() : '';
                
                // Validate required fields for each item
                if (!type || !brand) {
                    hasIncompleteItem = true;
                    incompleteItemIndex = index + 1;
                    return;
                }
                
                // If type is "Kh√°c", custom description is required
                if (type === 'Kh√°c' && !customDesc) {
                    hasIncompleteItem = true;
                    incompleteItemIndex = index + 1;
                    return;
                }
                
                requestItems.push({
                    type: type === 'Kh√°c' ? customDesc : type,
                    brand,
                    width: width ? parseFloat(width) : null,
                    height: height ? parseFloat(height) : null,
                    notes: notes || null
                });
            });
            
            if (hasIncompleteItem) {
                alert(`‚ùå H·∫°ng m·ª•c ${incompleteItemIndex} ch∆∞a ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!\n\n‚úÖ Y√™u c·∫ßu:\n‚Ä¢ Lo·∫°i h·∫°ng m·ª•c: B·∫Øt bu·ªôc\n‚Ä¢ Brand: B·∫Øt bu·ªôc\n‚Ä¢ M√¥ t·∫£ (n·∫øu ch·ªçn "Kh√°c"): B·∫Øt bu·ªôc\n\nVui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ho·∫∑c x√≥a h·∫°ng m·ª•c n√†y.`);
                return;
            }
            
            if (requestItems.length === 0) {
                alert('‚ùå Vui l√≤ng th√™m √≠t nh·∫•t 1 h·∫°ng m·ª•c kh·∫£o s√°t h·ª£p l·ªá!');
                return;
            }
            
            // Process uploaded images
            const imagePromises = [];
            for (let i = 0; i < imageFiles.length; i++) {
                const file = imageFiles[i];
                const promise = new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resolve({
                            name: file.name,
                            data: e.target.result
                        });
                    };
                    reader.readAsDataURL(file);
                });
                imagePromises.push(promise);
            }
            
            Promise.all(imagePromises).then(images => {
                const newRequest = {
                    id: Date.now(),
                    requesterName,
                    address,
                    content,
                    requestItems,
                    images: images,
                    createdAt: new Date().toLocaleString('vi-VN')
                };
                
                if (!outlets[currentOutletCode].requests) {
                    outlets[currentOutletCode].requests = [];
                }
                
                outlets[currentOutletCode].requests.push(newRequest);
                saveData();
                loadRequestList(currentOutletCode);
                loadOutletList();
                hideNewRequestForm();
                
                alert('T·∫°o y√™u c·∫ßu th√†nh c√¥ng!');
            });
        });

        function uploadMaquette(requestId) {
            if (!checkPermission('upload')) {
                alert('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn upload maquette!');
                return;
            }
            currentRequestId = requestId;
            const request = outlets[currentOutletCode].requests.find(r => r.id === requestId);
            if (!request) return;
            
            // Populate request info
            let requestInfo = `
                <div><strong>üë§ Ng∆∞·ªùi y√™u c·∫ßu:</strong> ${request.requesterName}</div>
                <div><strong>üïí Ng√†y t·∫°o:</strong> ${request.createdAt}</div>
            `;
            
            if (request.requestItems && request.requestItems.length > 0) {
                requestInfo += `<div><strong>üì¶ H·∫°ng m·ª•c:</strong> ${request.requestItems.length} h·∫°ng m·ª•c</div>`;
                request.requestItems.forEach((item, index) => {
                    requestInfo += `<div class="ml-4 text-sm">‚Ä¢ ${item.type} - ${item.shopName}</div>`;
                });
            }
            
            document.getElementById('requestInfo').innerHTML = requestInfo;
            
            document.getElementById('uploadMaquetteModal').style.display = 'flex';
        }

        function hideUploadMaquette() {
            document.getElementById('uploadMaquetteModal').style.display = 'none';
            document.getElementById('uploadMaquetteForm').reset();
            document.getElementById('maquettePreview').style.display = 'none';
            document.getElementById('maquettePreview').innerHTML = '';
            selectedMaquetteFiles = []; // Clear selected files
            currentRequestId = null;
        }

        function viewMaquette(requestId) {
            const request = outlets[currentOutletCode].requests.find(r => r.id === requestId);
            if (!request || !request.maquetteFiles) return;
            
            let content = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">üìã Th√¥ng Tin Y√™u C·∫ßu</h4>
                        <div class="text-sm text-gray-700 space-y-1">
                            <div><strong>üë§ Ng∆∞·ªùi y√™u c·∫ßu:</strong> ${request.requesterName}</div>
                            <div><strong>üïí Ng√†y ho√†n th√†nh:</strong> ${request.completedAt}</div>
            `;
            
            if (request.requestItems && request.requestItems.length > 0) {
                content += `<div><strong>üì¶ H·∫°ng m·ª•c:</strong> ${request.requestItems.length} h·∫°ng m·ª•c</div>`;
                request.requestItems.forEach((item, index) => {
                    content += `<div class="ml-4">‚Ä¢ ${item.type} - ${item.shopName}</div>`;
                });
            }
            
            content += `
                        </div>
                    </div>
            `;
            
            if (request.completionNotes) {
                content += `
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">üìù Ghi Ch√∫ Ho√†n Th√†nh</h4>
                        <p class="text-sm text-gray-700">${request.completionNotes}</p>
                    </div>
                `;
            }
            
            content += `
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">üñºÔ∏è Maquette Files (${request.maquetteFiles.length} file)</h4>
            `;
            
            // Display maquette files with preview
            if (request.maquetteData && request.maquetteData.length > 0) {
                content += `<div class="grid grid-cols-2 gap-4 mt-3">`;
                
                request.maquetteData.forEach((fileData, index) => {
                    if (fileData.type && fileData.type.startsWith('image/') && fileData.data) {
                        content += `
                            <div class="text-center">
                                <img src="${fileData.data}" alt="${fileData.name}" class="w-full h-32 object-cover rounded-lg border-2 border-gray-200 cursor-pointer hover:border-blue-400 transition-colors" onclick="showFullImage('${fileData.data}', '${fileData.name}')">
                                <p class="text-xs text-gray-600 mt-1">${fileData.name}</p>
                                <p class="text-xs text-green-600">üì∑ H√¨nh ·∫£nh</p>
                            </div>
                        `;
                    } else {
                        const fileIcon = fileData.type === 'application/pdf' ? 'üìÑ' : 'üìé';
                        const fileColor = fileData.type === 'application/pdf' ? 'text-red-600' : 'text-gray-600';
                        const fileType = fileData.type === 'application/pdf' ? 'PDF File' : 'File';
                        
                        content += `
                            <div class="text-center">
                                <div class="w-full h-32 bg-gray-100 rounded-lg border-2 border-gray-200 flex flex-col items-center justify-center">
                                    <span class="text-4xl mb-2">${fileIcon}</span>
                                    <p class="text-xs text-gray-600 px-2 truncate">${fileData.name}</p>
                                    <p class="text-xs ${fileColor}">${fileType}</p>
                                </div>
                            </div>
                        `;
                    }
                });
                
                content += `</div>`;
            } else {
                // Fallback for old data format
                content += `
                    <div class="text-sm text-gray-700">
                        <p><strong>S·ªë l∆∞·ª£ng file:</strong> ${request.maquetteFiles.length} file(s)</p>
                        <div class="mt-2 space-y-1">
                `;
                
                request.maquetteFiles.forEach((file, index) => {
                    content += `<div>üìé File ${index + 1}: ${file}</div>`;
                });
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            content += `
                    </div>
                </div>
            `;
            
            document.getElementById('maquetteContent').innerHTML = content;
            document.getElementById('viewMaquetteModal').style.display = 'flex';
        }

        function hideViewMaquette() {
            document.getElementById('viewMaquetteModal').style.display = 'none';
        }

        function viewRequestDetail(requestId) {
            const request = outlets[currentOutletCode].requests.find(r => r.id === requestId);
            if (!request) return;
            
            // Find request index for display
            const requestIndex = outlets[currentOutletCode].requests.findIndex(r => r.id === requestId);
            const requestNumber = requestIndex + 1;
            
            // Update modal title
            const modalTitle = document.querySelector('#viewMaquetteModal h3');
            modalTitle.textContent = `Xem Chi Ti·∫øt Y√™u C·∫ßu S·ªë ${requestNumber}`;
            
            // Create modal content instead of alert
            let content = `
                <div class="space-y-4">
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <h4 class="font-semibold text-orange-800 mb-2">Th√¥ng Tin C∆° B·∫£n</h4>
                        <div class="text-sm text-gray-700 space-y-1">
                            <div><strong>Ng∆∞·ªùi y√™u c·∫ßu:</strong> ${request.requesterName}</div>
                            <div><strong>ƒê·ªãa ch·ªâ:</strong> ${request.address}</div>
                            <div><strong>Ng√†y t·∫°o:</strong> ${request.createdAt}</div>
                        </div>
                    </div>
            `;
            
            if (request.content) {
                content += `
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <h4 class="font-semibold text-orange-800 mb-2">N·ªôi Dung B·∫£ng Hi·ªáu</h4>
                        <p class="text-sm text-gray-700">${request.content}</p>
                    </div>
                `;
            }
            
            if (request.requestItems && request.requestItems.length > 0) {
                content += `
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <h4 class="font-semibold text-orange-800 mb-2">H·∫°ng M·ª•c Kh·∫£o S√°t (${request.requestItems.length} h·∫°ng m·ª•c)</h4>
                        <div class="text-sm text-gray-700 space-y-2">
                `;
                request.requestItems.forEach((item, index) => {
                    content += `
                        <div class="border-l-4 border-purple-300 pl-3">
                            <div><strong>H·∫°ng m·ª•c ${index + 1}:</strong> ${item.type}</div>
                            <div><strong>üè∑Ô∏è Brand:</strong> ${item.brand}</div>
                    `;
                    if (item.width && item.height) {
                        content += `<div><strong>K√≠ch th∆∞·ªõc:</strong> ${item.width} x ${item.height} m</div>`;
                    }
                    if (item.notes) {
                        content += `<div><strong>Ghi ch√∫:</strong> ${item.notes}</div>`;
                    }
                    content += `</div>`;
                });
                content += `
                        </div>
                    </div>
                `;
            }
            
            // Display uploaded images
            if (request.images && request.images.length > 0) {
                content += `
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">üì∑ H√¨nh ·∫¢nh Th·ª±c T·∫ø (${request.images.length} ·∫£nh)</h4>
                        <div class="grid grid-cols-2 gap-4 mt-3">
                `;
                request.images.forEach((image, index) => {
                    content += `
                        <div class="text-center">
                            <img src="${image.data}" alt="${image.name}" class="w-full h-32 object-cover rounded-lg border-2 border-gray-200 cursor-pointer hover:border-blue-400 transition-colors" onclick="showFullImage('${image.data}', '${image.name}')">
                            <p class="text-xs text-gray-600 mt-1">${image.name}</p>
                        </div>
                    `;
                });
                content += `
                        </div>
                    </div>
                `;
            }
            
            // Display edit history if exists
            if (request.editHistory && request.editHistory.length > 0) {
                const hasUnfixedEdits = request.editHistory.some(edit => !edit.isFixed);
                
                content += `
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">‚úèÔ∏è L·ªãch S·ª≠ Ch·ªânh S·ª≠a (${request.editHistory.length} l·∫ßn)</h4>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                `;
                
                // Sort by newest first
                const sortedHistory = [...request.editHistory].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                sortedHistory.forEach((edit, index) => {
                    content += `
                        <div class="border-l-4 ${edit.isFixed ? 'border-green-400 bg-green-50' : 'border-red-400 bg-red-50'} p-2 rounded-r-lg">
                            <div class="text-xs text-gray-600 mb-1">
                                üìÖ ${edit.timestamp}
                                ${edit.isFixed ? '<span class="ml-2 text-green-600 font-semibold">‚úÖ ƒê√£ s·ª≠a xong</span>' : '<span class="ml-2 text-red-600 font-semibold">üîß C·∫ßn s·ª≠a</span>'}
                            </div>
                            <div class="text-sm text-gray-800">${edit.content}</div>
                        </div>
                    `;
                });
                
                content += `
                        </div>
                        <div class="mt-2 text-xs ${hasUnfixedEdits ? 'text-red-600' : 'text-green-600'}">
                            ${hasUnfixedEdits ? 'üîß C√≥ y√™u c·∫ßu ch·ªânh s·ª≠a ch∆∞a ho√†n th√†nh' : '‚úÖ T·∫•t c·∫£ ch·ªânh s·ª≠a ƒë√£ ho√†n th√†nh'}
                        </div>
                    </div>
                `;
            }

            if (request.completed) {
                content += `
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">‚úÖ Tr·∫°ng Th√°i Ho√†n Th√†nh</h4>
                        <div class="text-sm text-gray-700 space-y-1">
                            <div><strong>üïí Ng√†y ho√†n th√†nh:</strong> ${request.completedAt}</div>
                `;
                if (request.completionNotes) {
                    content += `<div><strong>üìù Ghi ch√∫ ho√†n th√†nh:</strong> ${request.completionNotes}</div>`;
                }
                if (request.maquetteFiles && request.maquetteFiles.length > 0) {
                    content += `<div><strong>üìé Files ƒë√£ upload:</strong> ${request.maquetteFiles.length} file(s)</div>`;
                }
                content += `
                        </div>
                    </div>
                `;
            } else {
                content += `
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">‚è≥ Tr·∫°ng Th√°i</h4>
                        <p class="text-sm text-gray-700">Y√™u c·∫ßu ch∆∞a ƒë∆∞·ª£c ho√†n th√†nh</p>
                    </div>
                `;
            }
            
            content += `</div>`;
            
            // Show in modal
            document.getElementById('maquetteContent').innerHTML = content;
            document.getElementById('viewMaquetteModal').style.display = 'flex';
        }

        function showFullImage(imageSrc, imageName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="max-w-4xl max-h-full bg-white rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">${imageName}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">
                            ‚úï ƒê√≥ng
                        </button>
                    </div>
                    <img src="${imageSrc}" alt="${imageName}" class="max-w-full max-h-96 object-contain mx-auto">
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Image preview functionality
        document.getElementById('requestImage').addEventListener('change', function(e) {
            const files = e.target.files;
            const preview = document.getElementById('imagePreview');
            
            if (files.length > 0) {
                preview.innerHTML = '';
                preview.style.display = 'grid';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'relative';
                        div.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}" class="w-full h-20 object-cover rounded border">
                            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 rounded-b truncate">
                                ${file.name}
                            </div>
                        `;
                        preview.appendChild(div);
                    };
                    
                    reader.readAsDataURL(file);
                }
            } else {
                preview.style.display = 'none';
            }
        });

        // Maquette files management
        let selectedMaquetteFiles = [];

        // Maquette preview functionality
        document.getElementById('maquetteFiles').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            // Add new files to selected files array
            files.forEach(file => {
                // Check if file already exists
                const exists = selectedMaquetteFiles.some(f => f.name === file.name && f.size === file.size);
                if (!exists) {
                    selectedMaquetteFiles.push(file);
                }
            });
            
            updateMaquettePreview();
            
            // Debug log
            console.log('Files selected:', selectedMaquetteFiles.length);
            
            // Don't clear the input - keep files there for form validation
            // e.target.value = '';
        });

        function updateMaquettePreview() {
            const preview = document.getElementById('maquettePreview');
            
            if (selectedMaquetteFiles.length > 0) {
                preview.innerHTML = '';
                preview.style.display = 'grid';
                
                selectedMaquetteFiles.forEach((file, index) => {
                    const div = document.createElement('div');
                    div.className = 'relative bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-3 text-center group hover:border-blue-400 transition-colors';
                    
                    // Delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity z-10';
                    deleteBtn.innerHTML = '‚úï';
                    deleteBtn.onclick = () => removeMaquetteFile(index);
                    
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            div.innerHTML = `
                                <img src="${e.target.result}" alt="${file.name}" class="w-full h-24 object-cover rounded mb-2 cursor-pointer hover:opacity-75 transition-opacity" onclick="showFullMaquetteImage('${e.target.result}', '${file.name}')">
                                <p class="text-xs text-gray-600 truncate">${file.name}</p>
                                <p class="text-xs text-green-600">üì∑ H√¨nh ·∫£nh</p>
                            `;
                            div.appendChild(deleteBtn);
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                        div.innerHTML = `
                            <div class="flex flex-col items-center">
                                <div class="w-16 h-16 bg-red-100 rounded-lg flex items-center justify-center mb-2 cursor-pointer hover:bg-red-200 transition-colors" onclick="alert('PDF Preview: ${file.name}\\nK√≠ch th∆∞·ªõc: ${(file.size/1024/1024).toFixed(2)} MB')">
                                    <span class="text-2xl">üìÑ</span>
                                </div>
                                <p class="text-xs text-gray-600 truncate">${file.name}</p>
                                <p class="text-xs text-red-600">PDF File</p>
                                <p class="text-xs text-gray-500">${(file.size/1024/1024).toFixed(2)} MB</p>
                            </div>
                        `;
                        div.appendChild(deleteBtn);
                    } else {
                        div.innerHTML = `
                            <div class="flex flex-col items-center">
                                <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mb-2">
                                    <span class="text-2xl">üìé</span>
                                </div>
                                <p class="text-xs text-gray-600 truncate">${file.name}</p>
                                <p class="text-xs text-gray-600">File</p>
                                <p class="text-xs text-gray-500">${(file.size/1024/1024).toFixed(2)} MB</p>
                            </div>
                        `;
                        div.appendChild(deleteBtn);
                    }
                    
                    preview.appendChild(div);
                });
            } else {
                preview.style.display = 'none';
            }
        }

        function removeMaquetteFile(index) {
            selectedMaquetteFiles.splice(index, 1);
            updateMaquettePreview();
        }

        function showFullMaquetteImage(imageSrc, imageName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="max-w-4xl max-h-full bg-white rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">üñºÔ∏è ${imageName}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">
                            ‚úï ƒê√≥ng
                        </button>
                    </div>
                    <img src="${imageSrc}" alt="${imageName}" class="max-w-full max-h-96 object-contain mx-auto rounded-lg shadow-lg">
                </div>
            `;
            document.body.appendChild(modal);
        }

        function editMaquette(requestId) {
            if (!checkPermission('upload')) {
                alert('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a maquette!');
                return;
            }
            if (!currentOutletCode) {
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y outlet hi·ªán t·∫°i');
                return;
            }
            
            const request = outlets[currentOutletCode].requests.find(r => r.id === requestId);
            if (!request) {
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu');
                return;
            }
            
            if (!request.completed) {
                alert('‚ö†Ô∏è Y√™u c·∫ßu n√†y ch∆∞a ƒë∆∞·ª£c ho√†n th√†nh');
                return;
            }
            
            currentRequestId = requestId;
            
            // Populate request info
            let requestInfo = `
                <div><strong>üë§ Ng∆∞·ªùi y√™u c·∫ßu:</strong> ${request.requesterName}</div>
                <div><strong>üïí Ho√†n th√†nh l√∫c:</strong> ${request.completedAt}</div>
            `;
            
            if (request.requestItems && request.requestItems.length > 0) {
                requestInfo += `<div><strong>üì¶ H·∫°ng m·ª•c:</strong> ${request.requestItems.length} h·∫°ng m·ª•c</div>`;
            }
            
            document.getElementById('editRequestInfo').innerHTML = requestInfo;
            
            // Show current files
            let currentFilesHtml = '';
            if (request.maquetteFiles && request.maquetteFiles.length > 0) {
                currentFilesHtml = `<div class="text-sm"><strong>üìé Files hi·ªán t·∫°i (${request.maquetteFiles.length}):</strong></div>`;
                request.maquetteFiles.forEach((file, index) => {
                    currentFilesHtml += `<div class="text-xs text-gray-600 ml-2">‚Ä¢ ${file}</div>`;
                });
            } else {
                currentFilesHtml = '<div class="text-sm text-gray-500">Kh√¥ng c√≥ files</div>';
            }
            document.getElementById('currentMaquetteFiles').innerHTML = currentFilesHtml;
            
            // Set current notes
            document.getElementById('editCompletionNotes').value = request.completionNotes || '';
            
            // Clear file input and preview
            document.getElementById('editMaquetteFiles').value = '';
            document.getElementById('editMaquettePreview').style.display = 'none';
            document.getElementById('editMaquettePreview').innerHTML = '';
            
            // Show modal
            document.getElementById('editMaquetteModal').style.display = 'flex';
        }

        function hideEditMaquette() {
            document.getElementById('editMaquetteModal').style.display = 'none';
            document.getElementById('editMaquetteForm').reset();
            document.getElementById('editMaquettePreview').style.display = 'none';
            document.getElementById('editMaquettePreview').innerHTML = '';
            currentRequestId = null;
        }

        // Edit Maquette Form submission
        document.getElementById('editMaquetteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const notes = document.getElementById('editCompletionNotes').value.trim();
            const fileInput = document.getElementById('editMaquetteFiles');
            const hasNewFiles = fileInput.files.length > 0;
            
            const requestIndex = outlets[currentOutletCode].requests.findIndex(r => r.id === currentRequestId);
            if (requestIndex === -1) {
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu');
                return;
            }
            
            // Update notes regardless of files
            outlets[currentOutletCode].requests[requestIndex].completionNotes = notes;
            
            if (hasNewFiles) {
                try {
                    const newFiles = Array.from(fileInput.files);
                    const uploaded = [];
                    for (const file of newFiles) {
                        const pathPrefix = `maquette/${currentOutletCode}/${currentRequestId || 'unknown'}`;
                        const { filePath, publicUrl } = await uploadFileToBucket(file, pathPrefix);
                        uploaded.push({ name: file.name, path: filePath, url: publicUrl, type: file.type });
                    }

                    // Replace old files with new ones (store names and public URLs)
                    outlets[currentOutletCode].requests[requestIndex].maquetteFiles = uploaded.map(f => f.name);
                    outlets[currentOutletCode].requests[requestIndex].maquetteData = uploaded; // now contains {name, path, url, type}

                    // Update completion time
                    outlets[currentOutletCode].requests[requestIndex].completedAt = new Date().toLocaleString('vi-VN');

                    saveData();
                    loadRequestList(currentOutletCode);
                    loadOutletList();
                    hideEditMaquette();

                    alert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t maquette l√™n Supabase th√†nh c√¥ng!\n\n‚Ä¢ Files ƒë√£ ƒë∆∞·ª£c upload\n‚Ä¢ ƒê√£ c·∫≠p nh·∫≠t ghi ch√∫\n‚Ä¢ ƒê√£ c·∫≠p nh·∫≠t th·ªùi gian ho√†n th√†nh');
                } catch (err) {
                    console.error(err);
                    alert('‚ùå L·ªói upload l√™n Supabase: ' + (err && err.message ? err.message : 'Unknown error'));
                }
            } else {
                // Only update notes, keep existing files
                saveData();
                loadRequestList(currentOutletCode);
                loadOutletList();
                hideEditMaquette();
                
                alert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t ghi ch√∫ th√†nh c√¥ng!\n\nFiles maquette gi·ªØ nguy√™n nh∆∞ c≈©.');
            }
        });

        // Edit maquette file preview
        document.getElementById('editMaquetteFiles').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const preview = document.getElementById('editMaquettePreview');
            
            if (files.length > 0) {
                preview.innerHTML = '';
                preview.style.display = 'grid';
                
                files.forEach((file, index) => {
                    const div = document.createElement('div');
                    div.className = 'relative bg-gray-50 border-2 border-dashed border-orange-300 rounded-lg p-3 text-center';
                    
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            div.innerHTML = `
                                <img src="${e.target.result}" alt="${file.name}" class="w-full h-24 object-cover rounded mb-2">
                                <p class="text-xs text-gray-600 truncate">${file.name}</p>
                                <p class="text-xs text-green-600">üì∑ H√¨nh ·∫£nh m·ªõi</p>
                            `;
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                        div.innerHTML = `
                            <div class="flex flex-col items-center">
                                <div class="w-16 h-16 bg-red-100 rounded-lg flex items-center justify-center mb-2">
                                    <span class="text-2xl">üìÑ</span>
                                </div>
                                <p class="text-xs text-gray-600 truncate">${file.name}</p>
                                <p class="text-xs text-red-600">PDF m·ªõi</p>
                            </div>
                        `;
                    } else {
                        div.innerHTML = `
                            <div class="flex flex-col items-center">
                                <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mb-2">
                                    <span class="text-2xl">üìé</span>
                                </div>
                                <p class="text-xs text-gray-600 truncate">${file.name}</p>
                                <p class="text-xs text-gray-600">File m·ªõi</p>
                            </div>
                        `;
                    }
                    
                    preview.appendChild(div);
                });
            } else {
                preview.style.display = 'none';
            }
        });

        // User request functions
        function requestEditOutlet(code) {
            if (!checkPermission('view')) {
                alert('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn y√™u c·∫ßu ch·ªânh s·ª≠a outlet!');
                return;
            }
            
            const outlet = outlets[code];
            if (!outlet) {
                alert('‚ùå Kh√¥ng t√¨m th·∫•y outlet');
                return;
            }
            
            const content = prompt(`üìù Y√äU C·∫¶U CH·ªàNH S·ª¨A OUTLET\n\nOutlet: ${outlet.name} (${code})\nKhu v·ª±c: ${outlet.area}\n\nVui l√≤ng m√¥ t·∫£ nh·ªØng thay ƒë·ªïi c·∫ßn thi·∫øt:`);
            
            if (!content || content.trim() === '') {
                return;
            }
            
            // Initialize outlet edit requests if not exists
            if (!outlets[code].editRequests) {
                outlets[code].editRequests = [];
            }
            
            const newEditRequest = {
                id: Date.now(),
                content: content.trim(),
                timestamp: new Date().toLocaleString('vi-VN'),
                requesterName: currentUser.name,
                requesterRole: currentUser.position || currentUser.role,
                requesterEmail: currentUser.email,
                status: 'pending' // pending, approved, rejected
            };
            
            outlets[code].editRequests.push(newEditRequest);
            saveData();
            loadOutletList();
            
            alert(`‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu ch·ªânh s·ª≠a outlet!\n\nY√™u c·∫ßu c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn Admin ƒë·ªÉ xem x√©t v√† ph√™ duy·ªát.`);
        }
        
        function requestDeleteOutlet(code) {
            if (!checkPermission('view')) {
                alert('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn y√™u c·∫ßu x√≥a outlet!');
                return;
            }
            
            const outlet = outlets[code];
            if (!outlet) {
                alert('‚ùå Kh√¥ng t√¨m th·∫•y outlet');
                return;
            }
            
            const requestCount = outlet.requests ? outlet.requests.length : 0;
            const pendingCount = outlet.requests ? outlet.requests.filter(r => !r.completed).length : 0;
            
            let confirmMessage = `üóëÔ∏è Y√äU C·∫¶U X√ìA OUTLET\n\n`;
            confirmMessage += `üìã Th√¥ng tin outlet:\n`;
            confirmMessage += `‚Ä¢ Code: ${code}\n`;
            confirmMessage += `‚Ä¢ T√™n: ${outlet.name}\n`;
            confirmMessage += `‚Ä¢ Khu v·ª±c: ${outlet.area}\n`;
            confirmMessage += `‚Ä¢ T·ªïng y√™u c·∫ßu: ${requestCount}\n`;
            
            if (pendingCount > 0) {
                confirmMessage += `‚Ä¢ Ch∆∞a ho√†n th√†nh: ${pendingCount}\n`;
            }
            
            confirmMessage += `\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën y√™u c·∫ßu x√≥a outlet n√†y?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const reason = prompt(`üìù L√ù DO X√ìA OUTLET\n\nVui l√≤ng n√™u r√µ l√Ω do t·∫°i sao c·∫ßn x√≥a outlet "${outlet.name}":`);
            
            if (!reason || reason.trim() === '') {
                return;
            }
            
            // Initialize outlet delete requests if not exists
            if (!outlets[code].deleteRequests) {
                outlets[code].deleteRequests = [];
            }
            
            const newDeleteRequest = {
                id: Date.now(),
                reason: reason.trim(),
                timestamp: new Date().toLocaleString('vi-VN'),
                requesterName: currentUser.name,
                requesterRole: currentUser.position || currentUser.role,
                requesterEmail: currentUser.email,
                status: 'pending' // pending, approved, rejected
            };
            
            outlets[code].deleteRequests.push(newDeleteRequest);
            saveData();
            loadOutletList();
            
            alert(`‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu x√≥a outlet!\n\nY√™u c·∫ßu x√≥a outlet "${outlet.name}" ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn Admin ƒë·ªÉ xem x√©t.`);
        }
        
        function requestCancelRequest(requestId) {
            if (!checkPermission('view')) {
                alert('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn y√™u c·∫ßu h·ªßy!');
                return;
            }
            
            if (!currentOutletCode) {
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y outlet hi·ªán t·∫°i');
                return;
            }
            
            const request = outlets[currentOutletCode].requests.find(r => r.id === requestId);
            if (!request) {
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu');
                return;
            }
            
            if (request.cancelRequested) {
                alert('‚ö†Ô∏è Y√™u c·∫ßu n√†y ƒë√£ ƒë∆∞·ª£c y√™u c·∫ßu h·ªßy tr∆∞·ªõc ƒë√≥!');
                return;
            }
            
            if (request.completed) {
                if (!confirm(`‚ö†Ô∏è Y√äU C·∫¶U H·ª¶Y C√îNG VI·ªÜC ƒê√É HO√ÄN TH√ÄNH\n\nY√™u c·∫ßu n√†y ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh.\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën y√™u c·∫ßu h·ªßy kh√¥ng?`)) {
                    return;
                }
            }
            
            const reason = prompt(`üìù L√ù DO H·ª¶Y Y√äU C·∫¶U\n\nY√™u c·∫ßu: ${request.requesterName} - ${request.createdAt}\n\nVui l√≤ng n√™u r√µ l√Ω do t·∫°i sao c·∫ßn h·ªßy y√™u c·∫ßu n√†y:`);
            
            if (!reason || reason.trim() === '') {
                return;
            }
            
            // Mark request as cancel requested
            const requestIndex = outlets[currentOutletCode].requests.findIndex(r => r.id === requestId);
            outlets[currentOutletCode].requests[requestIndex].cancelRequested = true;
            outlets[currentOutletCode].requests[requestIndex].cancelReason = reason.trim();
            outlets[currentOutletCode].requests[requestIndex].cancelRequestedBy = currentUser.name;
            outlets[currentOutletCode].requests[requestIndex].cancelRequestedAt = new Date().toLocaleString('vi-VN');
            outlets[currentOutletCode].requests[requestIndex].cancelRequestedRole = currentUser.position || currentUser.role;
            
            saveData();
            loadRequestList(currentOutletCode);
            loadOutletList();
            
            alert(`‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu h·ªßy!\n\nY√™u c·∫ßu h·ªßy ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn Admin ƒë·ªÉ xem x√©t v√† ph√™ duy·ªát.`);
        }
        
        function adminEditOutlet(code) {
            console.log('‚úÖ adminEditOutlet function called with code:', code);
            console.log('‚úÖ Current user:', currentUser);
            console.log('‚úÖ Checking permissions...');
            
            if (!checkPermission('manage')) {
                console.log('‚ùå Permission denied');
                alert('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a outlet!');
                return;
            }
            
            console.log('‚úÖ Permission granted');
            console.log('‚úÖ Looking for outlet:', code);
            console.log('‚úÖ Available outlets:', Object.keys(outlets));
            
            const outlet = outlets[code];
            if (!outlet) {
                console.log('‚ùå Outlet not found');
                alert('‚ùå Kh√¥ng t√¨m th·∫•y outlet');
                return;
            }
            
            console.log('‚úÖ Outlet found:', outlet);
            console.log('‚úÖ Populating form...');
            
            // Populate form with current data
            const codeElement = document.getElementById('editOutletCode');
            const nameElement = document.getElementById('editOutletName');
            const addressElement = document.getElementById('editOutletAddress');
            const areaElement = document.getElementById('editOutletArea');
            
            console.log('‚úÖ Form elements found:', {
                codeElement: !!codeElement,
                nameElement: !!nameElement,
                addressElement: !!addressElement,
                areaElement: !!areaElement
            });
            
            if (codeElement) codeElement.value = code;
            if (nameElement) nameElement.value = outlet.name;
            if (addressElement) addressElement.value = outlet.address || '';
            if (areaElement) areaElement.value = outlet.area;
            
            console.log('‚úÖ Form populated, showing modal...');
            
            // Show modal
            const modal = document.getElementById('editOutletModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('‚úÖ Modal displayed successfully');
            } else {
                console.log('‚ùå Modal element not found');
            }
        }

        function hideEditOutlet() {
            document.getElementById('editOutletModal').style.display = 'none';
            document.getElementById('editOutletForm').reset();
        }

        function deleteOutlet(code) {
            if (!checkPermission('manage')) {
                alert('‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a outlet!');
                return;
            }
            const outlet = outlets[code];
            if (!outlet) {
                alert('‚ùå Kh√¥ng t√¨m th·∫•y outlet');
                return;
            }
            
            const requestCount = outlet.requests ? outlet.requests.length : 0;
            const pendingCount = outlet.requests ? outlet.requests.filter(r => !r.completed).length : 0;
            
            // First confirmation
            let confirmMessage = `üóëÔ∏è X√ÅC NH·∫¨N X√ìA OUTLET\n\n`;
            confirmMessage += `üìã Th√¥ng tin outlet:\n`;
            confirmMessage += `‚Ä¢ Code: ${code}\n`;
            confirmMessage += `‚Ä¢ T√™n: ${outlet.name}\n`;
            confirmMessage += `‚Ä¢ Khu v·ª±c: ${outlet.area}\n`;
            confirmMessage += `‚Ä¢ T·ªïng y√™u c·∫ßu: ${requestCount}\n`;
            confirmMessage += `‚Ä¢ Ch∆∞a ho√†n th√†nh: ${pendingCount}\n\n`;
            
            if (requestCount > 0) {
                confirmMessage += `‚ö†Ô∏è C·∫¢NH B√ÅO: Outlet n√†y c√≥ ${requestCount} y√™u c·∫ßu!\n`;
                if (pendingCount > 0) {
                    confirmMessage += `üö® Trong ƒë√≥ c√≥ ${pendingCount} y√™u c·∫ßu ch∆∞a ho√†n th√†nh!\n`;
                }
                confirmMessage += `\n‚ùó Vi·ªác x√≥a s·∫Ω x√≥a vƒ©nh vi·ªÖn t·∫•t c·∫£ d·ªØ li·ªáu!\n`;
                confirmMessage += `\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?`;
            } else {
                confirmMessage += `‚ÑπÔ∏è Outlet n√†y ch∆∞a c√≥ y√™u c·∫ßu n√†o.\n`;
                confirmMessage += `\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a outlet n√†y?`;
            }
            
            const firstConfirm = confirm(confirmMessage);
            if (!firstConfirm) {
                return;
            }
            
            // Second confirmation (always show for any outlet)
            let secondMessage = `üö® X√ÅC NH·∫¨N L·∫¶N CU·ªêI!\n\n`;
            secondMessage += `B·∫°n s·∫Øp x√≥a vƒ©nh vi·ªÖn outlet:\n`;
            secondMessage += `"${outlet.name}" (${code})\n\n`;
            
            if (requestCount > 0) {
                secondMessage += `‚ö†Ô∏è S·∫Ω m·∫•t ${requestCount} y√™u c·∫ßu`;
                if (pendingCount > 0) {
                    secondMessage += ` (${pendingCount} ch∆∞a xong)`;
                }
                secondMessage += `!\n`;
            }
            
            secondMessage += `\n‚ùå KH√îNG TH·ªÇ KH√îI PH·ª§C SAU KHI X√ìA!\n`;
            secondMessage += `\nB·∫°n c√≥ th·ª±c s·ª± mu·ªën x√≥a kh√¥ng?`;
            
            const finalConfirm = confirm(secondMessage);
            if (!finalConfirm) {
                return;
            }
            
            try {
                // Delete outlet
                delete outlets[code];
                saveData();
                
                // Hide detail section if current outlet is deleted
                if (currentOutletCode === code) {
                    document.getElementById('outletDetailSection').style.display = 'none';
                    currentOutletCode = null;
                }
                
                // Reload lists
                loadOutletList();
                
                alert(`‚úÖ ƒê√É X√ìA TH√ÄNH C√îNG!\n\nOutlet "${outlet.name}" (${code}) ƒë√£ ƒë∆∞·ª£c x√≥a vƒ©nh vi·ªÖn.`);
                
            } catch (error) {
                console.error('Error deleting outlet:', error);
                alert('‚ùå L·ªói khi x√≥a outlet. Vui l√≤ng th·ª≠ l·∫°i!');
            }
        }

        // Edit Outlet Form submission
        document.getElementById('editOutletForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const code = document.getElementById('editOutletCode').value.trim();
            const name = document.getElementById('editOutletName').value.trim();
            const address = document.getElementById('editOutletAddress').value.trim();
            const area = document.getElementById('editOutletArea').value;
            
            if (!outlets[code]) {
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y outlet');
                return;
            }
            
            if (!address) {
                alert('‚ùå Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ outlet!');
                return;
            }
            
            // Update outlet data
            outlets[code].name = name;
            outlets[code].address = address;
            outlets[code].area = area;
            
            saveData();
            loadOutletList();
            hideEditOutlet();
            
            // Update detail section if currently viewing this outlet
            if (currentOutletCode === code) {
                document.getElementById('outletDetailTitle').textContent = `Chi Ti·∫øt Outlet: ${name}`;
                document.getElementById('outletDetailInfo').textContent = `Code: ${code} | Khu v·ª±c: ${area}`;
            }
            
            alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t outlet "${name}" th√†nh c√¥ng!`);
        });

        function editRequest(requestId) {
            console.log('‚úÖ editRequest called with ID:', requestId);
            console.log('‚úÖ currentOutletCode:', currentOutletCode);
            
            if (!currentOutletCode) {
                console.error('‚ùå currentOutletCode is null');
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y outlet hi·ªán t·∫°i');
                return;
            }
            
            if (!outlets[currentOutletCode]) {
                console.error('‚ùå Outlet not found:', currentOutletCode);
                alert('‚ùå L·ªói: Outlet kh√¥ng t·ªìn t·∫°i');
                return;
            }
            
            const request = outlets[currentOutletCode].requests.find(r => r.id === requestId);
            console.log('‚úÖ Found request:', request);
            
            if (!request) {
                console.error('‚ùå Request not found:', requestId);
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu');
                return;
            }
            
            currentRequestId = requestId;
            
            // Populate basic request info
            let basicInfo = `
                <div><strong>üë§ Ng∆∞·ªùi y√™u c·∫ßu:</strong> ${request.requesterName}</div>
                <div><strong>üïí Ng√†y t·∫°o:</strong> ${request.createdAt}</div>
                <div><strong>üìç ƒê·ªãa ch·ªâ:</strong> ${request.address}</div>
            `;
            
            if (request.requestItems && request.requestItems.length > 0) {
                basicInfo += `<div><strong>üì¶ H·∫°ng m·ª•c:</strong> ${request.requestItems.length} h·∫°ng m·ª•c</div>`;
            }
            
            const basicInfoElement = document.getElementById('editRequestBasicInfo');
            if (basicInfoElement) {
                basicInfoElement.innerHTML = basicInfo;
                console.log('‚úÖ Basic info populated');
            } else {
                console.error('‚ùå editRequestBasicInfo element not found');
            }
            
            // Update UI based on user role
            updateEditRequestUI();
            
            // Load edit history
            loadEditHistory(request);
            
            // Clear form
            const contentElement = document.getElementById('editRequestContent');
            if (contentElement) {
                contentElement.value = '';
                console.log('‚úÖ Form cleared');
            }
            
            // Show modal
            const modal = document.getElementById('editRequestModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('‚úÖ Modal displayed');
            } else {
                console.error('‚ùå editRequestModal not found');
            }
        }

        function updateEditRequestUI() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            const commentRoleTitle = document.getElementById('commentRoleTitle');
            const commentLabel = document.getElementById('commentLabel');
            const commentHint = document.getElementById('commentHint');
            const textarea = document.getElementById('editRequestContent');
            const markDoneBtn = document.getElementById('markDoneBtn');
            
            if (isAdmin) {
                // Admin - c√≥ c·∫£ n√∫t G·ª≠i v√† n√∫t Xong
                commentRoleTitle.textContent = 'Y√™u C·∫ßu Ch·ªânh S·ª≠a';
                commentLabel.textContent = 'N·ªôi Dung *';
                commentHint.textContent = 'M√¥ t·∫£ chi ti·∫øt';
                textarea.placeholder = 'Nh·∫≠p n·ªôi dung...';
                markDoneBtn.textContent = 'Xong';
                markDoneBtn.style.display = 'block';
            } else {
                // User - ch·ªâ c√≥ n√∫t G·ª≠i
                commentRoleTitle.textContent = 'Y√™u C·∫ßu Ch·ªânh S·ª≠a';
                commentLabel.textContent = 'N·ªôi Dung *';
                commentHint.textContent = 'M√¥ t·∫£ chi ti·∫øt';
                textarea.placeholder = 'Nh·∫≠p n·ªôi dung...';
                markDoneBtn.style.display = 'none';
            }
        }

        function loadEditHistory(request) {
            const historyContainer = document.getElementById('editHistoryList');
            const historyCount = document.getElementById('editHistoryCount');
            
            if (!request.editHistory || request.editHistory.length === 0) {
                historyContainer.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">Ch∆∞a c√≥ ch·ªânh s·ª≠a n√†o</div>';
                historyCount.textContent = '0';
                return;
            }
            
            historyContainer.innerHTML = '';
            historyCount.textContent = request.editHistory.length;
            
            // Sort by newest first
            const sortedHistory = [...request.editHistory].sort((a, b) => parseVietnameseDate(b.timestamp) - parseVietnameseDate(a.timestamp));
            
            sortedHistory.forEach((edit, index) => {
                const div = document.createElement('div');
                div.className = `border-l-4 ${edit.isFixed ? 'border-green-400 bg-green-50' : 'border-orange-400 bg-orange-50'} p-3 rounded-r-lg mb-2`;
                
                // Author info with role-based styling
                const authorName = edit.authorName || (edit.author === 'Admin' ? 'Admin' : 'User');
                let authorDisplay = '';
                
                if (edit.author === 'Admin') {
                    authorDisplay = `<span class="text-red-600 font-semibold">üîß ${authorName} (Admin)</span>`;
                } else if (edit.author === 'SR/TBA') {
                    authorDisplay = `<span class="text-blue-600 font-semibold">üë§ ${authorName} (SR/TBA)</span>`;
                } else if (edit.author === 'SS') {
                    authorDisplay = `<span class="text-green-600 font-semibold">üë• ${authorName} (SS)</span>`;
                } else {
                    authorDisplay = `<span class="text-gray-600 font-semibold">üìù ${authorName}</span>`;
                }
                
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-xs text-gray-600">
                            ${authorDisplay} ‚Ä¢ ${edit.timestamp}
                        </div>
                        <span class="text-xs ${edit.isFixed ? 'text-green-600 bg-green-100' : 'text-orange-600 bg-orange-100'} px-2 py-1 rounded-full">
                            ${edit.isFixed ? '‚úÖ ƒê√£ s·ª≠a' : 'üîß C·∫ßn s·ª≠a'}
                        </span>
                    </div>
                    <div class="text-sm text-gray-800">${edit.content}</div>
                `;
                
                historyContainer.appendChild(div);
            });
        }

        // Helper function to calculate time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) return 'V·ª´a xong';
            if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;
            if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
            if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;
            return `${Math.floor(diffDays / 7)} tu·∫ßn tr∆∞·ªõc`;
        }

        function hideEditRequest() {
            document.getElementById('editRequestModal').style.display = 'none';
            document.getElementById('editRequestForm').reset();
            currentRequestId = null;
        }

        function submitComment(isFixed) {
            const content = document.getElementById('editRequestContent').value.trim();
            
            if (!content) {
                alert('‚ùå Vui l√≤ng nh·∫≠p n·ªôi dung!');
                return;
            }
            
            const requestIndex = outlets[currentOutletCode].requests.findIndex(r => r.id === currentRequestId);
            if (requestIndex === -1) {
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y y√™u c·∫ßu');
                return;
            }
            
            // Initialize edit history if not exists
            if (!outlets[currentOutletCode].requests[requestIndex].editHistory) {
                outlets[currentOutletCode].requests[requestIndex].editHistory = [];
            }
            
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            // Add new edit entry
            const newEdit = {
                id: Date.now(),
                content: content,
                timestamp: new Date().toLocaleString('vi-VN'),
                isFixed: isFixed,
                author: isAdmin ? 'Admin' : currentUser.position || 'User',
                authorName: currentUser.name || 'Unknown User',
                authorEmail: currentUser.email || null
            };
            
            outlets[currentOutletCode].requests[requestIndex].editHistory.push(newEdit);
            
            // If marked as fixed, mark all previous edits as fixed too
            if (isFixed) {
                outlets[currentOutletCode].requests[requestIndex].editHistory.forEach(edit => {
                    edit.isFixed = true;
                });
            }
            
            saveData();
            loadRequestList(currentOutletCode);
            loadOutletList();
            
            if (isFixed) {
                alert(`‚úÖ ƒê√£ l∆∞u v√† ƒë√°nh d·∫•u ho√†n th√†nh!\n\nT·∫•t c·∫£ y√™u c·∫ßu ch·ªânh s·ª≠a ƒë√£ ƒë∆∞·ª£c ƒë√°nh d·∫•u l√† ho√†n th√†nh.`);
                hideEditRequest();
            } else {
                alert(`üí¨ ƒê√£ g·ª≠i y√™u c·∫ßu ch·ªânh s·ª≠a!\n\nComment ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o l·ªãch s·ª≠. Modal v·∫´n m·ªü ƒë·ªÉ b·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c th√™m comment.`);
                
                // Clear form but keep modal open
                document.getElementById('editRequestContent').value = '';
                
                // Reload edit history to show new comment
                const request = outlets[currentOutletCode].requests.find(r => r.id === currentRequestId);
                if (request) {
                    loadEditHistory(request);
                }
            }
        }



        // Character counter for edit request textarea
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('editRequestContent');
            const charCount = document.getElementById('charCount');
            
            if (textarea && charCount) {
                textarea.addEventListener('input', function() {
                    const count = this.value.length;
                    charCount.textContent = `${count} k√Ω t·ª±`;
                    
                    // Change color based on length
                    if (count < 10) {
                        charCount.className = 'text-xs text-gray-400';
                    } else if (count < 100) {
                        charCount.className = 'text-xs text-blue-500';
                    } else if (count < 500) {
                        charCount.className = 'text-xs text-green-500';
                    } else {
                        charCount.className = 'text-xs text-orange-500';
                    }
                });
            }
        });

        // Dropdown functions
        function toggleDropdown(code) {
            const dropdown = document.getElementById(`dropdown-${code}`);
            const arrow = document.querySelector(`.dropdown-arrow-${code}`);
            
            // Close all other dropdowns first
            document.querySelectorAll('[id^="dropdown-"]').forEach(dd => {
                if (dd.id !== `dropdown-${code}`) {
                    dd.classList.add('hidden');
                }
            });
            
            // Reset all arrows
            document.querySelectorAll('[class*="dropdown-arrow-"]').forEach(arr => {
                if (!arr.classList.contains(`dropdown-arrow-${code}`)) {
                    arr.style.transform = 'rotate(0deg)';
                }
            });
            
            // Toggle current dropdown
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                arrow.style.transform = 'rotate(180deg)';
            } else {
                dropdown.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function hideDropdown(code) {
            const dropdown = document.getElementById(`dropdown-${code}`);
            const arrow = document.querySelector(`.dropdown-arrow-${code}`);
            
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
            if (arrow) {
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('[onclick*="toggleDropdown"]') && !event.target.closest('[id^="dropdown-"]')) {
                document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
                    dropdown.classList.add('hidden');
                });
                document.querySelectorAll('[class*="dropdown-arrow-"]').forEach(arrow => {
                    arrow.style.transform = 'rotate(0deg)';
                });
            }
        });

        // Device Detection and Mobile Optimization
        function detectDevice() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
            const isTablet = /iPad|Android/i.test(navigator.userAgent) && window.innerWidth > 768 && window.innerWidth <= 1024;
            
            // Add device classes to body
            document.body.classList.remove('is-mobile', 'is-tablet', 'is-desktop');
            
            if (isMobile) {
                document.body.classList.add('is-mobile');
                optimizeForMobile();
            } else if (isTablet) {
                document.body.classList.add('is-tablet');
                optimizeForTablet();
            } else {
                document.body.classList.add('is-desktop');
                optimizeForDesktop();
            }
            
            return { isMobile, isTablet, isDesktop: !isMobile && !isTablet };
        }

        function optimizeForMobile() {
            // Apply mobile-specific optimizations
            console.log('üì± Mobile device detected - applying mobile optimizations');
            
            // Make modals full screen on mobile
            const modals = document.querySelectorAll('[id$="Modal"]');
            modals.forEach(modal => {
                const modalContent = modal.querySelector('.slide-in, .bg-white');
                if (modalContent) {
                    modalContent.classList.add('mobile-modal');
                }
            });
            
            // Optimize table for mobile scrolling
            const tables = document.querySelectorAll('table');
            tables.forEach(table => {
                const container = table.closest('.overflow-x-auto');
                if (container) {
                    container.classList.add('mobile-table');
                }
            });
        }

        function optimizeForTablet() {
            console.log('üì± Tablet device detected - applying tablet optimizations');
            // Tablet-specific optimizations can be added here
        }

        function optimizeForDesktop() {
            console.log('üñ•Ô∏è Desktop device detected - applying desktop optimizations');
            // Desktop-specific optimizations can be added here
        }

        // Handle window resize for responsive behavior
        function handleResize() {
            detectDevice();
            
            // Update table layout based on screen size
            const device = detectDevice();
            if (device.isMobile) {
                // Force horizontal scroll for tables on mobile
                document.querySelectorAll('.overflow-x-auto').forEach(container => {
                    container.style.overflowX = 'auto';
                });
            }
        }

        // Optimize touch interactions for mobile
        function optimizeTouchInteractions() {
            // Add touch-friendly classes to buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (!button.classList.contains('touch-btn')) {
                    button.classList.add('touch-btn');
                }
            });
            
            // Optimize dropdown behavior for mobile
            const dropdowns = document.querySelectorAll('[id^="dropdown-"]');
            dropdowns.forEach(dropdown => {
                if (detectDevice().isMobile) {
                    dropdown.classList.add('mobile-dropdown');
                }
            });
        }

        // Enhanced loadOutletList for mobile optimization
        function loadOutletListMobile() {
            loadOutletList(); // Call original function
            
            // Apply mobile-specific table optimizations
            if (detectDevice().isMobile) {
                const tbody = document.getElementById('outletTableBody');
                const rows = tbody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    // Make table cells more touch-friendly
                    const cells = row.querySelectorAll('td');
                    cells.forEach(cell => {
                        cell.classList.add('mobile-py-2');
                    });
                    
                    // Optimize button sizes for mobile
                    const buttons = row.querySelectorAll('button');
                    buttons.forEach(button => {
                        button.classList.add('mobile-btn', 'touch-btn');
                    });
                });
            }
        }

        // Override original loadOutletList
        const originalLoadOutletList = loadOutletList;
        loadOutletList = function() {
            originalLoadOutletList();
            
            // Apply mobile optimizations after loading
            setTimeout(() => {
                if (detectDevice().isMobile) {
                    optimizeTouchInteractions();
                }
            }, 100);
        };

        // Initialize device detection
        window.addEventListener('load', () => {
            detectDevice();
            optimizeTouchInteractions();
        });

        // Handle orientation change and resize
        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', () => {
            setTimeout(handleResize, 100); // Delay to ensure orientation change is complete
        });

        // Mobile Menu Toggle Function
        function toggleMobileMenu() {
            openMobilePendingOverlay();
        }
        
        // Open Mobile Pending Overlay
        function openMobilePendingOverlay() {
            const overlay = document.getElementById('mobilePendingOverlay');
            const hamburgerLine1 = document.getElementById('hamburger-line-1');
            const hamburgerLine2 = document.getElementById('hamburger-line-2');
            const hamburgerLine3 = document.getElementById('hamburger-line-3');
            
            // Show overlay
            overlay.style.display = 'flex';
            overlay.style.flexDirection = 'column';
            
            // Slide in from right
            setTimeout(() => {
                overlay.style.transform = 'translateX(0)';
            }, 10);
            
            // Transform hamburger to X
            hamburgerLine1.style.transform = 'rotate(45deg) translate(6px, 6px)';
            hamburgerLine2.style.opacity = '0';
            hamburgerLine3.style.transform = 'rotate(-45deg) translate(6px, -6px)';
            
            // Update button title
            document.getElementById('mobileMenuToggle').title = 'ƒê√≥ng danh s√°ch outlet ch∆∞a ho√†n th√†nh';
            
            // Update stats
            updatePendingStats();
        }
        
        // Close Mobile Pending Overlay
        function closeMobilePendingOverlay() {
            const overlay = document.getElementById('mobilePendingOverlay');
            const hamburgerLine1 = document.getElementById('hamburger-line-1');
            const hamburgerLine2 = document.getElementById('hamburger-line-2');
            const hamburgerLine3 = document.getElementById('hamburger-line-3');
            
            // Slide out to right
            overlay.style.transform = 'translateX(100%)';
            
            // Hide overlay after animation
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
            
            // Transform X back to hamburger
            hamburgerLine1.style.transform = 'rotate(0) translate(0, 0)';
            hamburgerLine2.style.opacity = '1';
            hamburgerLine3.style.transform = 'rotate(0) translate(0, 0)';
            
            // Update button title
            document.getElementById('mobileMenuToggle').title = 'Xem outlet ch∆∞a ho√†n th√†nh';
        }
        
        // Update Pending Stats
        function updatePendingStats() {
            const statsElement = document.getElementById('pendingStatsOverlay');
            if (!statsElement) return;
            
            let totalPending = 0;
            let totalEdits = 0;
            
            for (const [code, outlet] of Object.entries(outlets)) {
                const allRequests = outlet.requests || [];
                const pendingRequests = allRequests.filter(r => !r.completed);
                const needsEditRequests = allRequests.filter(r => {
                    return r.editHistory && r.editHistory.length > 0 && 
                           r.editHistory.some(edit => !edit.isFixed);
                });
                
                totalPending += pendingRequests.length;
                totalEdits += needsEditRequests.length;
            }
            
            const totalOutlets = Object.keys(outlets).length;
            const pendingOutlets = Object.values(outlets).filter(outlet => {
                const allRequests = outlet.requests || [];
                const pendingRequests = allRequests.filter(r => !r.completed);
                const needsEditRequests = allRequests.filter(r => {
                    return r.editHistory && r.editHistory.length > 0 && 
                           r.editHistory.some(edit => !edit.isFixed);
                });
                return pendingRequests.length > 0 || needsEditRequests.length > 0;
            }).length;
            
            statsElement.textContent = `${pendingOutlets}/${totalOutlets} outlet ‚Ä¢ ${totalPending} ch∆∞a xong ‚Ä¢ ${totalEdits} c·∫ßn s·ª≠a`;
        }

        // Initialize
        (async () => {
            // First try load from Supabase (shared across devices)
            await loadOutletsFromSupabase();
            // Then continue normal session/UI flow
            checkSession();
        })();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98a5f80467829daa',t:'MTc1OTc2MjIwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
